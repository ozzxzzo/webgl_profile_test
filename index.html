<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quantum Energy Ribbons - é‡å­èƒ½é‡ä¸å¸¦Â·ç»ˆæè±ªåç‰ˆ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            overflow: hidden;
        }

        body {
            background: #0a0a0f;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            cursor: none;
        }

        canvas {
            display: block;
            width: 100vw;
            height: 100vh;
        }

        #cursor {
            position: fixed;
            width: 40px;
            height: 40px;
            border: 2px solid #28f321;
            border-radius: 50%;
            pointer-events: none;
            z-index: 10000;
            mix-blend-mode: screen;
            transition: transform 0.1s ease;
            box-shadow: 0 0 20px rgba(40, 243, 33, 0.6),
                        inset 0 0 20px rgba(40, 243, 33, 0.3);
        }

        #cursor::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 6px;
            height: 6px;
            background: #28f321;
            border-radius: 50%;
            box-shadow: 0 0 10px #28f321;
        }

        #info {
            position: absolute;
            top: 20px;
            left: 20px;
            color: rgba(255, 255, 255, 0.7);
            font-size: 14px;
            pointer-events: none;
            text-shadow: 0 0 10px rgba(0, 0, 0, 0.5);
            line-height: 1.6;
            z-index: 100;
        }

        #info .title {
            font-size: 20px;
            font-weight: bold;
            color: #28f321;
            text-shadow: 0 0 15px rgba(40, 243, 33, 0.8);
            margin-bottom: 8px;
        }

        #info .features {
            margin-top: 10px;
            font-size: 10px;
            color: rgba(255, 255, 255, 0.5);
        }

        #loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: #28f321;
            font-size: 24px;
            text-shadow: 0 0 20px #28f321;
        }

        #controlPanel {
            position: absolute;
            top: 20px;
            right: 20px;
            width: 360px;
            max-height: 90vh;
            overflow-y: auto;
            background: rgba(10, 10, 15, 0.95);
            border: 1px solid rgba(40, 243, 33, 0.3);
            border-radius: 12px;
            padding: 20px;
            color: #fff;
            font-size: 13px;
            box-shadow: 0 0 40px rgba(40, 243, 33, 0.2), 0 0 80px rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(15px);
            display: none;
            opacity: 0;
            transform: translateX(20px);
            transition: opacity 0.3s ease, transform 0.3s ease;
            z-index: 100;
        }

        #controlPanel.visible {
            opacity: 1;
            transform: translateX(0);
        }

        #controlPanel h2 {
            margin: 0 0 15px 0;
            font-size: 20px;
            color: #28f321;
            text-shadow: 0 0 15px rgba(40, 243, 33, 0.6);
            text-align: center;
        }

        .control-section {
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .control-section:last-child {
            border-bottom: none;
        }

        .control-section h3 {
            margin: 0 0 12px 0;
            font-size: 15px;
            color: #2196F3;
            font-weight: bold;
        }

        .control-group {
            margin-bottom: 12px;
        }

        .control-group label {
            display: block;
            margin-bottom: 6px;
            color: rgba(255, 255, 255, 0.85);
            font-size: 12px;
        }

        .control-group input[type="range"] {
            width: 100%;
            height: 4px;
            border-radius: 2px;
            background: rgba(255, 255, 255, 0.2);
            outline: none;
            -webkit-appearance: none;
        }

        .control-group input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 14px;
            height: 14px;
            border-radius: 50%;
            background: #28f321;
            cursor: pointer;
            box-shadow: 0 0 8px rgba(40, 243, 33, 0.6);
        }

        .control-group input[type="range"]::-moz-range-thumb {
            width: 14px;
            height: 14px;
            border-radius: 50%;
            background: #28f321;
            cursor: pointer;
            border: none;
            box-shadow: 0 0 8px rgba(40, 243, 33, 0.6);
        }

        .control-group input[type="color"] {
            width: 100%;
            height: 32px;
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 4px;
            background: transparent;
            cursor: pointer;
        }

        .control-group input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
            margin-right: 8px;
            vertical-align: middle;
        }

        .control-group .checkbox-label {
            display: inline-block;
            vertical-align: middle;
        }

        .control-group .value-display {
            float: right;
            color: #28f321;
            font-weight: bold;
            font-size: 12px;
        }

        button {
            width: 100%;
            padding: 12px;
            margin-top: 10px;
            background: rgba(40, 243, 33, 0.15);
            border: 1px solid #28f321;
            border-radius: 6px;
            color: #28f321;
            font-size: 13px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
        }

        button:hover {
            background: rgba(40, 243, 33, 0.25);
            box-shadow: 0 0 20px rgba(40, 243, 33, 0.4);
            transform: translateY(-1px);
        }

        button:active {
            transform: translateY(0);
        }

        .toggle-btn {
            position: absolute;
            top: 20px;
            right: 20px;
            padding: 10px 18px;
            width: auto;
            background: rgba(10, 10, 15, 0.9);
            border: 1px solid rgba(40, 243, 33, 0.4);
            margin: 0;
            transition: right 0.3s ease;
            font-size: 12px;
            z-index: 100;
        }

        #controlPanel::-webkit-scrollbar {
            width: 6px;
        }

        #controlPanel::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 3px;
        }

        #controlPanel::-webkit-scrollbar-thumb {
            background: rgba(40, 243, 33, 0.5);
            border-radius: 3px;
        }

        #controlPanel::-webkit-scrollbar-thumb:hover {
            background: rgba(40, 243, 33, 0.7);
        }

        .effect-badge {
            display: inline-block;
            padding: 3px 10px;
            margin: 3px;
            background: rgba(40, 243, 33, 0.2);
            border: 1px solid rgba(40, 243, 33, 0.4);
            border-radius: 12px;
            font-size: 10px;
            color: #28f321;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div id="cursor"></div>
    <div id="loading">Loading Ultimate Effects...</div>
    <div id="info">
        <div class="title">âš¡ Quantum Energy Ribbons âš¡</div>
        <div>é‡å­èƒ½é‡ä¸å¸¦ Â· ç»ˆæè±ªåç‰ˆ</div>
        <div class="features">
            <span class="effect-badge">ğŸ§² Magnetic</span>
            <span class="effect-badge">ğŸ’— Pulse</span>
            <span class="effect-badge">ğŸ“· DOF</span><br>
            <span class="effect-badge">âš¡ Glitch</span>
            <span class="effect-badge">âœ¨ Fresnel</span>
            <span class="effect-badge">ğŸ’ Reflect</span>
        </div>
    </div>

    <button class="toggle-btn" onclick="togglePanel()">æ§åˆ¶é¢æ¿</button>

    <div id="controlPanel">
        <h2>ğŸ›ï¸ ç»ˆææ§åˆ¶é¢æ¿</h2>

        <div class="control-section">
            <h3>ğŸ¨ åŸºç¡€å‚æ•° Basic</h3>
            <div class="control-group">
                <label>æ›²é¢æ•°é‡ Surfaces: <span class="value-display" id="surfaceCount-value">1</span></label>
                <input type="range" id="surfaceCount" min="1" max="10" step="1" value="1">
            </div>
            <div class="control-group">
                <label>ç½‘æ ¼å¯†åº¦ Grid Density: <span class="value-display" id="gridDensity-value">1.7</span></label>
                <input type="range" id="gridDensity" min="0.2" max="2" step="0.1" value="1.7">
            </div>
            <div class="control-group">
                <label>ä¸å¸¦å®½åº¦ Ribbon Width: <span class="value-display" id="surfaceWidth-value">200</span></label>
                <input type="range" id="surfaceWidth" min="30" max="200" step="5" value="200">
            </div>
            <div class="control-group">
                <label>ä¸å¸¦é«˜åº¦ Ribbon Height: <span class="value-display" id="surfaceHeight-value">29</span></label>
                <input type="range" id="surfaceHeight" min="5" max="40" step="1" value="29">
            </div>
        </div>

        <div class="control-section">
            <h3>ğŸŒˆ é¢œè‰² Colors</h3>
            <div class="control-group">
                <label>èµ·å§‹é¢œè‰² Start Color</label>
                <input type="color" id="colorStart" value="#28f321">
            </div>
            <div class="control-group">
                <label>ç»“æŸé¢œè‰² End Color</label>
                <input type="color" id="colorEnd" value="#2196f3">
            </div>
            <div class="control-group">
                <label>é¢œè‰²æµåŠ¨é€Ÿåº¦ Color Flow: <span class="value-display" id="colorFlowSpeed-value">0.05</span></label>
                <input type="range" id="colorFlowSpeed" min="0" max="0.5" step="0.01" value="0.05">
            </div>
        </div>

        <div class="control-section">
            <h3>ğŸ§² ç£æ€§å¸é™„ Magnetic Field</h3>
            <div class="control-group">
                <label>
                    <input type="checkbox" id="enableMagnetic" checked>
                    <span class="checkbox-label">å¯ç”¨ç£æ€§å¸é™„ Enable Magnetic</span>
                </label>
            </div>
            <div class="control-group">
                <label>å¸é™„å¼ºåº¦ Strength: <span class="value-display" id="magneticStrength-value">15.0</span></label>
                <input type="range" id="magneticStrength" min="0" max="50" step="1" value="15">
            </div>
            <div class="control-group">
                <label>ä½œç”¨èŒƒå›´ Range: <span class="value-display" id="magneticRange-value">100</span></label>
                <input type="range" id="magneticRange" min="20" max="200" step="10" value="100">
            </div>
        </div>

        <div class="control-section">
            <h3>ğŸ’— èƒ½é‡è„‰å†² Energy Pulse</h3>
            <div class="control-group">
                <label>
                    <input type="checkbox" id="enablePulse" checked>
                    <span class="checkbox-label">å¯ç”¨è„‰å†² Enable Pulse</span>
                </label>
            </div>
            <div class="control-group">
                <label>è„‰å†²é€Ÿåº¦ Speed: <span class="value-display" id="pulseSpeed-value">0.5</span></label>
                <input type="range" id="pulseSpeed" min="0.1" max="2" step="0.1" value="0.5">
            </div>
            <div class="control-group">
                <label>è„‰å†²å¼ºåº¦ Intensity: <span class="value-display" id="pulseIntensity-value">2.0</span></label>
                <input type="range" id="pulseIntensity" min="0.5" max="5" step="0.1" value="2.0">
            </div>
            <div class="control-group">
                <label>è„‰å†²é¢‘ç‡ Frequency: <span class="value-display" id="pulseFrequency-value">1.0</span></label>
                <input type="range" id="pulseFrequency" min="0.1" max="3" step="0.1" value="1.0">
            </div>
        </div>

        <div class="control-section">
            <h3>ğŸ“· æ™¯æ·± Depth of Field</h3>
            <div class="control-group">
                <label>
                    <input type="checkbox" id="enableDOF" checked>
                    <span class="checkbox-label">å¯ç”¨æ™¯æ·± Enable DOF</span>
                </label>
            </div>
            <div class="control-group">
                <label>ç„¦è· Focus Distance: <span class="value-display" id="focusDistance-value">50</span></label>
                <input type="range" id="focusDistance" min="20" max="150" step="5" value="50">
            </div>
            <div class="control-group">
                <label>æ™¯æ·±èŒƒå›´ DOF Range: <span class="value-display" id="dofRange-value">30</span></label>
                <input type="range" id="dofRange" min="10" max="100" step="5" value="30">
            </div>
            <div class="control-group">
                <label>è™šåŒ–å¼ºåº¦ Blur Strength: <span class="value-display" id="blurStrength-value">1.5</span></label>
                <input type="range" id="blurStrength" min="0" max="5" step="0.1" value="1.5">
            </div>
        </div>

        <div class="control-section">
            <h3>âš¡ å…¨æ¯æ•…éšœ Holographic Glitch</h3>
            <div class="control-group">
                <label>
                    <input type="checkbox" id="enableGlitch" checked>
                    <span class="checkbox-label">å¯ç”¨æ•…éšœ Enable Glitch</span>
                </label>
            </div>
            <div class="control-group">
                <label>æ•…éšœå¼ºåº¦ Intensity: <span class="value-display" id="glitchIntensity-value">0.3</span></label>
                <input type="range" id="glitchIntensity" min="0" max="1" step="0.05" value="0.3">
            </div>
            <div class="control-group">
                <label>æ•…éšœé¢‘ç‡ Frequency: <span class="value-display" id="glitchFrequency-value">0.1</span></label>
                <input type="range" id="glitchFrequency" min="0.01" max="0.5" step="0.01" value="0.1">
            </div>
        </div>

        <div class="control-section">
            <h3>âœ¨ è¾¹ç¼˜å‘å…‰ Fresnel Glow</h3>
            <div class="control-group">
                <label>
                    <input type="checkbox" id="enableFresnel" checked>
                    <span class="checkbox-label">å¯ç”¨è¾¹ç¼˜å…‰ Enable Fresnel</span>
                </label>
            </div>
            <div class="control-group">
                <label>å‘å…‰å¼ºåº¦ Intensity: <span class="value-display" id="fresnelIntensity-value">1.5</span></label>
                <input type="range" id="fresnelIntensity" min="0" max="5" step="0.1" value="1.5">
            </div>
            <div class="control-group">
                <label>å‘å…‰åŠŸç‡ Power: <span class="value-display" id="fresnelPower-value">2.0</span></label>
                <input type="range" id="fresnelPower" min="0.5" max="5" step="0.1" value="2.0">
            </div>
        </div>

        <div class="control-section">
            <h3>ğŸ’ åå°„æŠ˜å°„ Reflection</h3>
            <div class="control-group">
                <label>
                    <input type="checkbox" id="enableReflection" checked>
                    <span class="checkbox-label">å¯ç”¨åå°„ Enable Reflection</span>
                </label>
            </div>
            <div class="control-group">
                <label>åå°„å¼ºåº¦ Intensity: <span class="value-display" id="reflectionIntensity-value">0.6</span></label>
                <input type="range" id="reflectionIntensity" min="0" max="2" step="0.1" value="0.6">
            </div>
            <div class="control-group">
                <label>æŠ˜å°„ç‡ Refraction: <span class="value-display" id="refractionIndex-value">1.5</span></label>
                <input type="range" id="refractionIndex" min="1" max="3" step="0.1" value="1.5">
            </div>
        </div>

        <div class="control-section">
            <h3>âœ¨ å…‰æ•ˆ Lighting</h3>
            <div class="control-group">
                <label>è¾‰å…‰å¼ºåº¦ Bloom Strength: <span class="value-display" id="bloomStrength-value">1.7</span></label>
                <input type="range" id="bloomStrength" min="0" max="3" step="0.1" value="1.7">
            </div>
            <div class="control-group">
                <label>è¾‰å…‰åŠå¾„ Bloom Radius: <span class="value-display" id="bloomRadius-value">0.00</span></label>
                <input type="range" id="bloomRadius" min="0" max="1" step="0.05" value="0.00">
            </div>
            <div class="control-group">
                <label>è¾‰å…‰é˜ˆå€¼ Bloom Threshold: <span class="value-display" id="bloomThreshold-value">0.55</span></label>
                <input type="range" id="bloomThreshold" min="0" max="1" step="0.05" value="0.55">
            </div>
            <div class="control-group">
                <label>äº®åº¦ Brightness: <span class="value-display" id="brightness-value">1.5</span></label>
                <input type="range" id="brightness" min="0.5" max="3" step="0.1" value="1.5">
            </div>
        </div>

        <div class="control-section">
            <h3>ğŸŒŠ æ³¢åŠ¨æ•ˆæœ Wave Effects</h3>
            <div class="control-group">
                <label>æ³¢åŠ¨å¹…åº¦ Wave Amplitude: <span class="value-display" id="waveAmplitude-value">1.7</span></label>
                <input type="range" id="waveAmplitude" min="0" max="8" step="0.1" value="1.7">
            </div>
            <div class="control-group">
                <label>æ³¢åŠ¨é€Ÿåº¦ Wave Speed: <span class="value-display" id="waveSpeed-value">0.27</span></label>
                <input type="range" id="waveSpeed" min="0" max="1" step="0.01" value="0.27">
            </div>
            <div class="control-group">
                <label>èºæ—‹é¢‘ç‡ Spiral Frequency: <span class="value-display" id="spiralFreq-value">11.5</span></label>
                <input type="range" id="spiralFreq" min="0" max="12" step="0.5" value="11.5">
            </div>
            <div class="control-group">
                <label>èºæ—‹å¹…åº¦ Spiral Amplitude: <span class="value-display" id="spiralAmp-value">1.3</span></label>
                <input type="range" id="spiralAmp" min="0" max="5" step="0.1" value="1.3">
            </div>
            <div class="control-group">
                <label>æ‰­æ›²å¼ºåº¦ Twist Strength: <span class="value-display" id="twistStrength-value">1.9</span></label>
                <input type="range" id="twistStrength" min="0" max="3" step="0.1" value="1.9">
            </div>
            <div class="control-group">
                <label>DNAæ•ˆæœå¼ºåº¦ DNA Effect: <span class="value-display" id="dnaStrength-value">0.5</span></label>
                <input type="range" id="dnaStrength" min="0" max="2" step="0.1" value="0.5">
            </div>
        </div>

        <div class="control-section">
            <h3>âœ¨ ç²’å­ Particles</h3>
            <div class="control-group">
                <label>ç²’å­å¤§å° Particle Size: <span class="value-display" id="particleSize-value">0.8</span></label>
                <input type="range" id="particleSize" min="0.2" max="2" step="0.1" value="0.8">
            </div>
            <div class="control-group">
                <label>ç²’å­è„‰åŠ¨ Particle Pulse: <span class="value-display" id="particlePulse-value">0.20</span></label>
                <input type="range" id="particlePulse" min="0" max="1" step="0.05" value="0.20">
            </div>
        </div>

        <div class="control-section">
            <h3>ğŸ“· ç›¸æœºä¸ç¯å¢ƒ Camera</h3>
            <div class="control-group">
                <label>ç›¸æœºè·ç¦» Camera Distance: <span class="value-display" id="cameraZ-value">50</span></label>
                <input type="range" id="cameraZ" min="20" max="150" step="5" value="50">
            </div>
            <div class="control-group">
                <label>è§†é‡è§’åº¦ FOV: <span class="value-display" id="fov-value">60</span></label>
                <input type="range" id="fov" min="30" max="120" step="5" value="60">
            </div>
            <div class="control-group">
                <label>é›¾å¯†åº¦ Fog Density: <span class="value-display" id="fogDensity-value">0.011</span></label>
                <input type="range" id="fogDensity" min="0" max="0.02" step="0.001" value="0.011">
            </div>
            <div class="control-group">
                <label>åŠ¨ç”»é€Ÿåº¦ Animation Speed: <span class="value-display" id="timeSpeed-value">0.8</span></label>
                <input type="range" id="timeSpeed" min="0" max="3" step="0.1" value="0.8">
            </div>
        </div>

        <button onclick="resetToDefault()">ğŸ”„ é‡ç½®é»˜è®¤å€¼ Reset</button>
        <button onclick="randomize()">ğŸ² éšæœºåŒ– Randomize</button>
        <button onclick="toggleAllEffects()">âš¡ å…¨æ•ˆæœå¼€å…³ Toggle All</button>
    </div>

    <script type="importmap">
    {
        "imports": {
            "three": "https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.module.js",
            "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.160.0/examples/jsm/"
        }
    }
    </script>

    <script type="module">
        import * as THREE from 'three';
        import { EffectComposer } from 'three/addons/postprocessing/EffectComposer.js';
        import { RenderPass } from 'three/addons/postprocessing/RenderPass.js';
        import { UnrealBloomPass } from 'three/addons/postprocessing/UnrealBloomPass.js';
        import { ShaderPass } from 'three/addons/postprocessing/ShaderPass.js';
        import { OutputPass } from 'three/addons/postprocessing/OutputPass.js';

        // åœºæ™¯è®¾ç½®
        let scene, camera, renderer, composer, bloomPass, dofPass, glitchPass;
        let ribbons = [];
        let time = 0;
        let mouse = { x: 0, y: 0, worldX: 0, worldY: 0, worldZ: 0 };
        let energyPulses = [];

        // é…ç½®å‚æ•°
        const config = {
            // åŸºç¡€å‚æ•°
            surfaceCount: 1,
            gridWidth: 200,
            gridHeight: 60,
            surfaceWidth: 200,
            surfaceHeight: 29,
            gridDensity: 1.7,

            // é¢œè‰²å‚æ•°
            colorStart: new THREE.Color(0x28f321),
            colorEnd: new THREE.Color(0x2196F3),
            colorFlowSpeed: 0.05,

            // å…‰æ•ˆå‚æ•°
            bloomStrength: 1.7,
            bloomRadius: 0.00,
            bloomThreshold: 0.55,
            brightness: 1.5,

            // æ³¢åŠ¨æ•ˆæœå‚æ•°
            waveAmplitude: 1.7,
            waveSpeed: 0.27,
            spiralFreq: 11.5,
            spiralAmp: 1.3,
            twistStrength: 1.9,
            dnaStrength: 0.5,

            // ç²’å­å‚æ•°
            particleSize: 0.8,
            particlePulse: 0.20,

            // ç›¸æœºä¸ç¯å¢ƒ
            cameraZ: 50,
            fov: 60,
            fogDensity: 0.011,
            timeSpeed: 0.8,

            // æ–°å¢ç‰¹æ•ˆå‚æ•°
            enableMagnetic: true,
            magneticStrength: 15,
            magneticRange: 100,

            enablePulse: true,
            pulseSpeed: 0.5,
            pulseIntensity: 2.0,
            pulseFrequency: 1.0,

            enableDOF: true,
            focusDistance: 50,
            dofRange: 30,
            blurStrength: 1.5,

            enableGlitch: true,
            glitchIntensity: 0.3,
            glitchFrequency: 0.1,

            enableFresnel: true,
            fresnelIntensity: 1.5,
            fresnelPower: 2.0,

            enableReflection: true,
            reflectionIntensity: 0.6,
            refractionIndex: 1.5
        };

        // é»˜è®¤é…ç½®å¤‡ä»½
        const defaultConfig = JSON.parse(JSON.stringify({...config, colorStart: 0x28f321, colorEnd: 0x2196F3}));

        // æ™¯æ·±ç€è‰²å™¨
        const DOFShader = {
            uniforms: {
                'tDiffuse': { value: null },
                'tDepth': { value: null },
                'focusDistance': { value: 50.0 },
                'dofRange': { value: 30.0 },
                'blurStrength': { value: 1.5 },
                'cameraNear': { value: 0.1 },
                'cameraFar': { value: 1000.0 }
            },
            vertexShader: `
                varying vec2 vUv;
                void main() {
                    vUv = uv;
                    gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);
                }
            `,
            fragmentShader: `
                uniform sampler2D tDiffuse;
                uniform float focusDistance;
                uniform float dofRange;
                uniform float blurStrength;
                varying vec2 vUv;

                void main() {
                    vec4 color = texture2D(tDiffuse, vUv);

                    // ç®€åŒ–çš„æ™¯æ·±æ¨¡ç³Š
                    float depth = gl_FragCoord.z / gl_FragCoord.w;
                    float blur = abs(depth - focusDistance) / dofRange;
                    blur = clamp(blur * blurStrength, 0.0, 1.0);

                    // ç®€å•çš„æ¨¡ç³Šé‡‡æ ·
                    vec4 blurred = vec4(0.0);
                    float samples = 9.0;
                    float offset = blur * 0.003;

                    for(float x = -1.0; x <= 1.0; x++) {
                        for(float y = -1.0; y <= 1.0; y++) {
                            vec2 sampleUv = vUv + vec2(x, y) * offset;
                            blurred += texture2D(tDiffuse, sampleUv);
                        }
                    }
                    blurred /= samples;

                    gl_FragColor = mix(color, blurred, blur);
                }
            `
        };

        // æ•…éšœæ•ˆæœç€è‰²å™¨
        const GlitchShader = {
            uniforms: {
                'tDiffuse': { value: null },
                'time': { value: 0.0 },
                'intensity': { value: 0.3 },
                'frequency': { value: 0.1 }
            },
            vertexShader: `
                varying vec2 vUv;
                void main() {
                    vUv = uv;
                    gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);
                }
            `,
            fragmentShader: `
                uniform sampler2D tDiffuse;
                uniform float time;
                uniform float intensity;
                uniform float frequency;
                varying vec2 vUv;

                float random(vec2 st) {
                    return fract(sin(dot(st.xy, vec2(12.9898, 78.233))) * 43758.5453123);
                }

                void main() {
                    vec2 uv = vUv;

                    // éšæœºé—ªçƒ
                    float glitchRandom = random(vec2(floor(time * 10.0), floor(uv.y * 100.0)));

                    if(glitchRandom < frequency * intensity) {
                        // RGBåˆ†ç¦»
                        float offset = (random(vec2(time, uv.y)) - 0.5) * intensity * 0.05;
                        vec4 r = texture2D(tDiffuse, uv + vec2(offset, 0.0));
                        vec4 g = texture2D(tDiffuse, uv);
                        vec4 b = texture2D(tDiffuse, uv - vec2(offset, 0.0));
                        gl_FragColor = vec4(r.r, g.g, b.b, 1.0);

                        // æ‰«æçº¿
                        float scanline = sin(uv.y * 800.0 + time * 20.0) * 0.5 + 0.5;
                        gl_FragColor.rgb *= 0.8 + scanline * 0.2;
                    } else {
                        // æ¨ªå‘å¹²æ‰°æ¡
                        float lineGlitch = step(0.99, random(vec2(floor(time * 5.0), floor(uv.y * 50.0))));
                        if(lineGlitch > 0.5) {
                            uv.x += (random(vec2(time, uv.y)) - 0.5) * intensity * 0.1;
                        }

                        vec4 color = texture2D(tDiffuse, uv);

                        // åƒç´ åŒ–é—ªçƒ
                        float pixelGlitch = step(0.98, random(vec2(floor(uv.x * 500.0), floor(uv.y * 500.0) + time)));
                        color.rgb = mix(color.rgb, vec3(1.0), pixelGlitch * intensity * 0.5);

                        gl_FragColor = color;
                    }
                }
            `
        };

        // è‡ªå®šä¹‰é¼ æ ‡å…‰æ ‡
        const cursor = document.getElementById('cursor');
        document.addEventListener('mousemove', (e) => {
            cursor.style.left = e.clientX - 20 + 'px';
            cursor.style.top = e.clientY - 20 + 'px';

            // æ›´æ–°é¼ æ ‡ä¸–ç•Œåæ ‡
            mouse.x = (e.clientX / window.innerWidth) * 2 - 1;
            mouse.y = -(e.clientY / window.innerHeight) * 2 + 1;

            // è½¬æ¢ä¸ºä¸–ç•Œåæ ‡
            const vector = new THREE.Vector3(mouse.x, mouse.y, 0.5);
            vector.unproject(camera);
            const dir = vector.sub(camera.position).normalize();
            const distance = -camera.position.z / dir.z;
            const pos = camera.position.clone().add(dir.multiplyScalar(distance));

            mouse.worldX = pos.x;
            mouse.worldY = pos.y;
            mouse.worldZ = 0;
        });

        document.addEventListener('click', () => {
            cursor.style.transform = 'scale(1.5)';
            setTimeout(() => {
                cursor.style.transform = 'scale(1)';
            }, 150);
        });

        // æ§åˆ¶é¢æ¿åˆ‡æ¢
        window.togglePanel = function() {
            const panel = document.getElementById('controlPanel');
            const toggleBtn = document.querySelector('.toggle-btn');
            const isVisible = panel.classList.contains('visible');

            if (!isVisible) {
                panel.style.display = 'block';
                setTimeout(() => {
                    panel.classList.add('visible');
                }, 10);
                toggleBtn.style.right = '400px';
                toggleBtn.textContent = 'éšè—é¢æ¿';
            } else {
                panel.classList.remove('visible');
                setTimeout(() => {
                    panel.style.display = 'none';
                }, 300);
                toggleBtn.style.right = '20px';
                toggleBtn.textContent = 'æ§åˆ¶é¢æ¿';
            }
        }

        // é‡ç½®ä¸ºé»˜è®¤å€¼
        window.resetToDefault = function() {
            config.colorStart = new THREE.Color(defaultConfig.colorStart);
            config.colorEnd = new THREE.Color(defaultConfig.colorEnd);
            Object.assign(config, {...defaultConfig, colorStart: config.colorStart, colorEnd: config.colorEnd});
            updateUIFromConfig();
            needsRebuild = true;
        }

        // éšæœºåŒ–å‚æ•°
        window.randomize = function() {
            config.surfaceCount = Math.floor(Math.random() * 8) + 2;
            config.gridDensity = Math.random() * 1.5 + 0.5;
            config.surfaceWidth = Math.random() * 120 + 50;
            config.surfaceHeight = Math.random() * 30 + 10;
            config.colorFlowSpeed = Math.random() * 0.4;
            config.bloomStrength = Math.random() * 2 + 0.5;
            config.bloomRadius = Math.random();
            config.bloomThreshold = Math.random() * 0.5;
            config.brightness = Math.random() * 2 + 0.5;
            config.waveAmplitude = Math.random() * 6 + 1;
            config.waveSpeed = Math.random() * 0.8 + 0.1;
            config.spiralFreq = Math.random() * 10 + 1;
            config.spiralAmp = Math.random() * 4 + 0.5;
            config.twistStrength = Math.random() * 2;
            config.dnaStrength = Math.random() * 1.5;
            config.particleSize = Math.random() * 1.5 + 0.3;
            config.particlePulse = Math.random() * 0.8;
            config.cameraZ = Math.random() * 80 + 40;
            config.fov = Math.random() * 60 + 40;
            config.fogDensity = Math.random() * 0.015;
            config.timeSpeed = Math.random() * 2 + 0.2;

            const randomColor1 = '#' + Math.floor(Math.random()*16777215).toString(16).padStart(6, '0');
            const randomColor2 = '#' + Math.floor(Math.random()*16777215).toString(16).padStart(6, '0');
            config.colorStart = new THREE.Color(randomColor1);
            config.colorEnd = new THREE.Color(randomColor2);

            config.magneticStrength = Math.random() * 40 + 10;
            config.magneticRange = Math.random() * 150 + 50;
            config.pulseSpeed = Math.random() * 1.5 + 0.2;
            config.pulseIntensity = Math.random() * 4 + 1;
            config.glitchIntensity = Math.random() * 0.8;
            config.fresnelIntensity = Math.random() * 4 + 0.5;
            config.reflectionIntensity = Math.random() * 1.5;

            updateUIFromConfig();
            needsRebuild = true;
        }

        // å…¨æ•ˆæœå¼€å…³
        window.toggleAllEffects = function() {
            const allEnabled = config.enableMagnetic && config.enablePulse &&
                             config.enableDOF && config.enableGlitch &&
                             config.enableFresnel && config.enableReflection;

            config.enableMagnetic = !allEnabled;
            config.enablePulse = !allEnabled;
            config.enableDOF = !allEnabled;
            config.enableGlitch = !allEnabled;
            config.enableFresnel = !allEnabled;
            config.enableReflection = !allEnabled;

            updateUIFromConfig();
        }

        // ä»é…ç½®æ›´æ–°UI
        function updateUIFromConfig() {
            document.getElementById('surfaceCount').value = config.surfaceCount;
            document.getElementById('surfaceCount-value').textContent = config.surfaceCount;

            document.getElementById('gridDensity').value = config.gridDensity;
            document.getElementById('gridDensity-value').textContent = config.gridDensity.toFixed(1);

            document.getElementById('surfaceWidth').value = config.surfaceWidth;
            document.getElementById('surfaceWidth-value').textContent = Math.round(config.surfaceWidth);

            document.getElementById('surfaceHeight').value = config.surfaceHeight;
            document.getElementById('surfaceHeight-value').textContent = Math.round(config.surfaceHeight);

            document.getElementById('colorStart').value = '#' + config.colorStart.getHexString();
            document.getElementById('colorEnd').value = '#' + config.colorEnd.getHexString();

            document.getElementById('colorFlowSpeed').value = config.colorFlowSpeed;
            document.getElementById('colorFlowSpeed-value').textContent = config.colorFlowSpeed.toFixed(2);

            document.getElementById('bloomStrength').value = config.bloomStrength;
            document.getElementById('bloomStrength-value').textContent = config.bloomStrength.toFixed(1);

            document.getElementById('bloomRadius').value = config.bloomRadius;
            document.getElementById('bloomRadius-value').textContent = config.bloomRadius.toFixed(2);

            document.getElementById('bloomThreshold').value = config.bloomThreshold;
            document.getElementById('bloomThreshold-value').textContent = config.bloomThreshold.toFixed(2);

            document.getElementById('brightness').value = config.brightness;
            document.getElementById('brightness-value').textContent = config.brightness.toFixed(1);

            document.getElementById('waveAmplitude').value = config.waveAmplitude;
            document.getElementById('waveAmplitude-value').textContent = config.waveAmplitude.toFixed(1);

            document.getElementById('waveSpeed').value = config.waveSpeed;
            document.getElementById('waveSpeed-value').textContent = config.waveSpeed.toFixed(2);

            document.getElementById('spiralFreq').value = config.spiralFreq;
            document.getElementById('spiralFreq-value').textContent = config.spiralFreq.toFixed(1);

            document.getElementById('spiralAmp').value = config.spiralAmp;
            document.getElementById('spiralAmp-value').textContent = config.spiralAmp.toFixed(1);

            document.getElementById('twistStrength').value = config.twistStrength;
            document.getElementById('twistStrength-value').textContent = config.twistStrength.toFixed(1);

            document.getElementById('dnaStrength').value = config.dnaStrength;
            document.getElementById('dnaStrength-value').textContent = config.dnaStrength.toFixed(1);

            document.getElementById('particleSize').value = config.particleSize;
            document.getElementById('particleSize-value').textContent = config.particleSize.toFixed(1);

            document.getElementById('particlePulse').value = config.particlePulse;
            document.getElementById('particlePulse-value').textContent = config.particlePulse.toFixed(2);

            document.getElementById('cameraZ').value = config.cameraZ;
            document.getElementById('cameraZ-value').textContent = Math.round(config.cameraZ);

            document.getElementById('fov').value = config.fov;
            document.getElementById('fov-value').textContent = Math.round(config.fov);

            document.getElementById('fogDensity').value = config.fogDensity;
            document.getElementById('fogDensity-value').textContent = config.fogDensity.toFixed(3);

            document.getElementById('timeSpeed').value = config.timeSpeed;
            document.getElementById('timeSpeed-value').textContent = config.timeSpeed.toFixed(1);

            // æ–°å¢ç‰¹æ•ˆ
            document.getElementById('enableMagnetic').checked = config.enableMagnetic;
            document.getElementById('magneticStrength').value = config.magneticStrength;
            document.getElementById('magneticStrength-value').textContent = config.magneticStrength.toFixed(1);
            document.getElementById('magneticRange').value = config.magneticRange;
            document.getElementById('magneticRange-value').textContent = Math.round(config.magneticRange);

            document.getElementById('enablePulse').checked = config.enablePulse;
            document.getElementById('pulseSpeed').value = config.pulseSpeed;
            document.getElementById('pulseSpeed-value').textContent = config.pulseSpeed.toFixed(1);
            document.getElementById('pulseIntensity').value = config.pulseIntensity;
            document.getElementById('pulseIntensity-value').textContent = config.pulseIntensity.toFixed(1);
            document.getElementById('pulseFrequency').value = config.pulseFrequency;
            document.getElementById('pulseFrequency-value').textContent = config.pulseFrequency.toFixed(1);

            document.getElementById('enableDOF').checked = config.enableDOF;
            document.getElementById('focusDistance').value = config.focusDistance;
            document.getElementById('focusDistance-value').textContent = Math.round(config.focusDistance);
            document.getElementById('dofRange').value = config.dofRange;
            document.getElementById('dofRange-value').textContent = Math.round(config.dofRange);
            document.getElementById('blurStrength').value = config.blurStrength;
            document.getElementById('blurStrength-value').textContent = config.blurStrength.toFixed(1);

            document.getElementById('enableGlitch').checked = config.enableGlitch;
            document.getElementById('glitchIntensity').value = config.glitchIntensity;
            document.getElementById('glitchIntensity-value').textContent = config.glitchIntensity.toFixed(2);
            document.getElementById('glitchFrequency').value = config.glitchFrequency;
            document.getElementById('glitchFrequency-value').textContent = config.glitchFrequency.toFixed(2);

            document.getElementById('enableFresnel').checked = config.enableFresnel;
            document.getElementById('fresnelIntensity').value = config.fresnelIntensity;
            document.getElementById('fresnelIntensity-value').textContent = config.fresnelIntensity.toFixed(1);
            document.getElementById('fresnelPower').value = config.fresnelPower;
            document.getElementById('fresnelPower-value').textContent = config.fresnelPower.toFixed(1);

            document.getElementById('enableReflection').checked = config.enableReflection;
            document.getElementById('reflectionIntensity').value = config.reflectionIntensity;
            document.getElementById('reflectionIntensity-value').textContent = config.reflectionIntensity.toFixed(1);
            document.getElementById('refractionIndex').value = config.refractionIndex;
            document.getElementById('refractionIndex-value').textContent = config.refractionIndex.toFixed(1);
        }

        // éœ€è¦é‡å»ºæ ‡å¿—
        let needsRebuild = false;

        // åˆå§‹åŒ–åœºæ™¯
        function init() {
            scene = new THREE.Scene();
            scene.fog = new THREE.FogExp2(0x0a0a0f, config.fogDensity);

            camera = new THREE.PerspectiveCamera(
                config.fov,
                window.innerWidth / window.innerHeight,
                0.1,
                1000
            );
            camera.position.set(0, 0, config.cameraZ);
            camera.lookAt(0, 0, 0);

            renderer = new THREE.WebGLRenderer({
                antialias: true,
                alpha: true
            });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
            renderer.toneMapping = THREE.ACESFilmicToneMapping;
            renderer.toneMappingExposure = config.brightness;
            document.body.appendChild(renderer.domElement);

            setupPostProcessing();
            createSurfaces();
            setupControls();
            updateUIFromConfig();

            window.addEventListener('resize', onWindowResize);
            document.getElementById('loading').style.display = 'none';
        }

        // è®¾ç½®åå¤„ç†
        function setupPostProcessing() {
            composer = new EffectComposer(renderer);

            const renderPass = new RenderPass(scene, camera);
            composer.addPass(renderPass);

            bloomPass = new UnrealBloomPass(
                new THREE.Vector2(window.innerWidth, window.innerHeight),
                config.bloomStrength,
                config.bloomRadius,
                config.bloomThreshold
            );
            composer.addPass(bloomPass);

            dofPass = new ShaderPass(DOFShader);
            dofPass.uniforms['focusDistance'].value = config.focusDistance;
            dofPass.uniforms['dofRange'].value = config.dofRange;
            dofPass.uniforms['blurStrength'].value = config.blurStrength;
            composer.addPass(dofPass);

            glitchPass = new ShaderPass(GlitchShader);
            glitchPass.uniforms['intensity'].value = config.glitchIntensity;
            glitchPass.uniforms['frequency'].value = config.glitchFrequency;
            composer.addPass(glitchPass);

            const outputPass = new OutputPass();
            composer.addPass(outputPass);
        }

        // åˆ›å»ºç²’å­æè´¨ï¼ˆå¸¦Fresnelå’Œåå°„ï¼‰
        function createParticleMaterial() {
            return new THREE.ShaderMaterial({
                uniforms: {
                    time: { value: 0 },
                    colorStart: { value: config.colorStart },
                    colorEnd: { value: config.colorEnd },
                    fresnelIntensity: { value: config.fresnelIntensity },
                    fresnelPower: { value: config.fresnelPower },
                    reflectionIntensity: { value: config.reflectionIntensity },
                    enableFresnel: { value: config.enableFresnel ? 1.0 : 0.0 },
                    enableReflection: { value: config.enableReflection ? 1.0 : 0.0 }
                },
                vertexShader: `
                    attribute float alpha;
                    attribute float size;
                    attribute vec3 customColor;

                    varying vec3 vColor;
                    varying float vAlpha;
                    varying vec3 vPosition;
                    varying vec3 vNormal;
                    varying vec3 vViewPosition;

                    void main() {
                        vColor = customColor;
                        vAlpha = alpha;
                        vPosition = position;

                        // è®¡ç®—æ³•çº¿ï¼ˆè¿‘ä¼¼ï¼‰
                        vNormal = normalize(position);

                        vec4 mvPosition = modelViewMatrix * vec4(position, 1.0);
                        vViewPosition = -mvPosition.xyz;

                        gl_PointSize = size * (300.0 / -mvPosition.z);
                        gl_Position = projectionMatrix * mvPosition;
                    }
                `,
                fragmentShader: `
                    uniform float time;
                    uniform vec3 colorStart;
                    uniform vec3 colorEnd;
                    uniform float fresnelIntensity;
                    uniform float fresnelPower;
                    uniform float reflectionIntensity;
                    uniform float enableFresnel;
                    uniform float enableReflection;

                    varying vec3 vColor;
                    varying float vAlpha;
                    varying vec3 vPosition;
                    varying vec3 vNormal;
                    varying vec3 vViewPosition;

                    void main() {
                        // åˆ›å»ºåœ†è§’æ­£æ–¹å½¢ç²’å­
                        vec2 center = gl_PointCoord - vec2(0.5);
                        vec2 absCenter = abs(center);

                        float cornerRadius = 0.15;
                        float squareSize = 0.45;

                        vec2 d = absCenter - vec2(squareSize - cornerRadius);
                        float dist = length(max(d, 0.0)) + min(max(d.x, d.y), 0.0) - cornerRadius;

                        if (dist > 0.0) discard;

                        // è¾¹ç¼˜æ¸å˜
                        float strength = 1.0 - smoothstep(-0.1, 0.0, dist);
                        strength = pow(strength, 1.5);

                        // Fresnel è¾¹ç¼˜å‘å…‰
                        vec3 normal = normalize(vNormal);
                        vec3 viewDir = normalize(vViewPosition);
                        float fresnel = pow(1.0 - max(dot(normal, viewDir), 0.0), fresnelPower);
                        fresnel *= fresnelIntensity;

                        // åå°„æ•ˆæœï¼ˆç®€åŒ–çš„ç¯å¢ƒæ˜ å°„ï¼‰
                        vec3 reflection = reflect(-viewDir, normal);
                        float reflectionFactor = (sin(reflection.x * 10.0 + time) * 0.5 + 0.5) *
                                                (cos(reflection.y * 10.0 + time * 0.7) * 0.5 + 0.5);
                        reflectionFactor *= reflectionIntensity;

                        // ç»„åˆæ‰€æœ‰æ•ˆæœ
                        vec3 finalColor = vColor * 1.8;

                        if (enableFresnel > 0.5) {
                            finalColor += vec3(fresnel) * mix(colorStart, colorEnd, 0.5);
                        }

                        if (enableReflection > 0.5) {
                            finalColor += vec3(reflectionFactor) * 0.5;
                        }

                        gl_FragColor = vec4(finalColor, strength * vAlpha);
                    }
                `,
                transparent: true,
                blending: THREE.AdditiveBlending,
                depthWrite: false
            });
        }

        // åˆ›å»ºå…‰æµæ›²é¢
        function createSurfaces() {
            for (let i = 0; i < config.surfaceCount; i++) {
                const surface = createSurface(i, config.surfaceCount);
                ribbons.push(surface);
                scene.add(surface.points);
            }
        }

        // åˆ›å»ºå•ä¸ªå…‰æµæ›²é¢
        function createSurface(index, total) {
            const gridW = Math.floor(config.gridWidth * config.gridDensity);
            const gridH = Math.floor(config.gridHeight * config.gridDensity);
            const particleCount = gridW * gridH;
            const geometry = new THREE.BufferGeometry();

            const positions = new Float32Array(particleCount * 3);
            const colors = new Float32Array(particleCount * 3);
            const alphas = new Float32Array(particleCount);
            const sizes = new Float32Array(particleCount);
            const offsets = new Float32Array(particleCount);
            const gridCoords = new Float32Array(particleCount * 2);

            const yOffset = (index - total / 2) * 8;
            const zOffset = (index % 2 === 0 ? 1 : -1) * (3 + index * 2);

            let idx = 0;
            for (let iy = 0; iy < gridH; iy++) {
                for (let ix = 0; ix < gridW; ix++) {
                    const u = ix / (gridW - 1);
                    const v = iy / (gridH - 1);

                    gridCoords[idx * 2] = u;
                    gridCoords[idx * 2 + 1] = v;

                    const x = (u - 0.5) * config.surfaceWidth;
                    const y = (v - 0.5) * config.surfaceHeight + yOffset;
                    const z = zOffset;

                    positions[idx * 3] = x;
                    positions[idx * 3 + 1] = y;
                    positions[idx * 3 + 2] = z;

                    const color = new THREE.Color();
                    color.lerpColors(config.colorStart, config.colorEnd, u);
                    colors[idx * 3] = color.r;
                    colors[idx * 3 + 1] = color.g;
                    colors[idx * 3 + 2] = color.b;

                    const edgeFadeX = Math.sin(u * Math.PI);
                    const edgeFadeY = Math.sin(v * Math.PI);
                    alphas[idx] = edgeFadeX * edgeFadeY * 0.8 + 0.2;

                    sizes[idx] = config.particleSize + Math.random() * 0.3;
                    offsets[idx] = Math.random() * Math.PI * 2;

                    idx++;
                }
            }

            geometry.setAttribute('position', new THREE.BufferAttribute(positions, 3));
            geometry.setAttribute('customColor', new THREE.BufferAttribute(colors, 3));
            geometry.setAttribute('alpha', new THREE.BufferAttribute(alphas, 1));
            geometry.setAttribute('size', new THREE.BufferAttribute(sizes, 1));

            const material = createParticleMaterial();
            const points = new THREE.Points(geometry, material);

            return {
                points,
                geometry,
                offsets,
                gridCoords,
                gridW,
                gridH,
                yOffset,
                zOffset,
                phaseOffset: index * 1.2
            };
        }

        // åˆ›å»ºèƒ½é‡è„‰å†²
        function createEnergyPulse() {
            if (!config.enablePulse) return;

            const pulse = {
                position: 0, // 0 åˆ° 1ï¼Œè¡¨ç¤ºä»å·¦åˆ°å³çš„ä½ç½®
                intensity: config.pulseIntensity,
                width: 0.15,
                speed: config.pulseSpeed
            };

            energyPulses.push(pulse);
        }

        // æ›´æ–°èƒ½é‡è„‰å†²
        function updateEnergyPulses() {
            // å‘¨æœŸæ€§åˆ›å»ºæ–°è„‰å†²
            if (config.enablePulse && Math.sin(time * config.pulseFrequency * Math.PI) > 0.99) {
                createEnergyPulse();
            }

            // æ›´æ–°ç°æœ‰è„‰å†²
            for (let i = energyPulses.length - 1; i >= 0; i--) {
                const pulse = energyPulses[i];
                pulse.position += pulse.speed * 0.01;

                // ç§»é™¤è¶…å‡ºèŒƒå›´çš„è„‰å†²
                if (pulse.position > 1.2) {
                    energyPulses.splice(i, 1);
                }
            }
        }

        // æ›´æ–°å…‰æµæ›²é¢åŠ¨ç”»
        function updateRibbons() {
            ribbons.forEach((surface, surfaceIndex) => {
                const positions = surface.geometry.attributes.position.array;
                const colors = surface.geometry.attributes.customColor.array;
                const sizes = surface.geometry.attributes.size.array;
                const alphas = surface.geometry.attributes.alpha.array;

                let idx = 0;
                for (let iy = 0; iy < surface.gridH; iy++) {
                    for (let ix = 0; ix < surface.gridW; ix++) {
                        const u = surface.gridCoords[idx * 2];
                        const v = surface.gridCoords[idx * 2 + 1];

                        const x = (u - 0.5) * config.surfaceWidth;
                        const y = (v - 0.5) * config.surfaceHeight + surface.yOffset;
                        const z = surface.zOffset;

                        const waveOffset = surface.phaseOffset + time * config.waveSpeed;

                        // åŸæœ‰æ³¢åŠ¨æ•ˆæœ
                        const spiralY = Math.sin(u * Math.PI * config.spiralFreq + waveOffset + v * Math.PI * 2) * config.spiralAmp;
                        const spiralZ = Math.cos(u * Math.PI * config.spiralFreq + waveOffset + v * Math.PI * 2) * config.spiralAmp;

                        const wave1 = Math.sin(u * Math.PI * 3 + waveOffset) * config.waveAmplitude * 0.8;
                        const wave2 = Math.cos(v * Math.PI * 4 + waveOffset * 1.5) * config.waveAmplitude * 0.5;

                        const centerX = u - 0.5;
                        const centerY = v - 0.5;
                        const distFromCenter = Math.sqrt(centerX * centerX + centerY * centerY);
                        const radialWave = Math.sin(distFromCenter * Math.PI * 6 + waveOffset * 2) * config.waveAmplitude * 0.3;

                        const twistX = Math.sin(u * Math.PI * 12 + time * 2) * Math.cos(v * Math.PI * 6 + time) * config.twistStrength;
                        const twistY = Math.cos(u * Math.PI * 6 + time * 1.5) * Math.sin(v * Math.PI * 12 + time * 2) * config.twistStrength;

                        const dnaPhase = u * Math.PI * 8 + waveOffset * 3;
                        const dnaY = Math.sin(dnaPhase + v * Math.PI) * config.dnaStrength;
                        const dnaZ = Math.cos(dnaPhase + v * Math.PI) * config.dnaStrength;

                        let finalX = x + twistX;
                        let finalY = y + spiralY + wave1 + wave2 + radialWave + dnaY + twistY;
                        let finalZ = z + spiralZ + dnaZ;

                        // ç£æ€§å¸é™„æ•ˆæœ
                        if (config.enableMagnetic) {
                            const dx = mouse.worldX - finalX;
                            const dy = mouse.worldY - finalY;
                            const dz = mouse.worldZ - finalZ;
                            const distance = Math.sqrt(dx * dx + dy * dy + dz * dz);

                            if (distance < config.magneticRange) {
                                const force = (1 - distance / config.magneticRange) * config.magneticStrength;
                                finalX += (dx / distance) * force * 0.1;
                                finalY += (dy / distance) * force * 0.1;
                                finalZ += (dz / distance) * force * 0.1;
                            }
                        }

                        // èƒ½é‡è„‰å†²æ•ˆæœ
                        let pulseEffect = 0;
                        if (config.enablePulse) {
                            energyPulses.forEach(pulse => {
                                const distToPulse = Math.abs(u - pulse.position);
                                if (distToPulse < pulse.width) {
                                    const pulseFactor = 1 - (distToPulse / pulse.width);
                                    pulseEffect += pulseFactor * pulse.intensity;
                                }
                            });
                        }

                        finalY += pulseEffect * Math.sin(v * Math.PI * 2);
                        finalZ += pulseEffect * Math.cos(v * Math.PI * 2);

                        positions[idx * 3] = finalX;
                        positions[idx * 3 + 1] = finalY;
                        positions[idx * 3 + 2] = finalZ;

                        // åŠ¨æ€å¾ªç¯æ¸å˜è‰²
                        const flowOffset = (time * config.colorFlowSpeed) % 1.0;
                        const colorPos = (u + flowOffset) % 1.0;

                        let t;
                        if (colorPos < 0.5) {
                            t = colorPos * 2;
                        } else {
                            t = (1.0 - colorPos) * 2;
                        }

                        t = t * t * (3 - 2 * t);

                        const color = new THREE.Color();
                        color.lerpColors(config.colorStart, config.colorEnd, t);

                        // è„‰å†²é¢œè‰²å¢å¼º
                        if (pulseEffect > 0) {
                            color.r = Math.min(1, color.r + pulseEffect * 0.3);
                            color.g = Math.min(1, color.g + pulseEffect * 0.3);
                            color.b = Math.min(1, color.b + pulseEffect * 0.3);
                        }

                        colors[idx * 3] = color.r;
                        colors[idx * 3 + 1] = color.g;
                        colors[idx * 3 + 2] = color.b;

                        // å¾‹åŠ¨çš„ç²’å­å¤§å°
                        const pulse1 = Math.sin(time * 2 + u * Math.PI * 6) * config.particlePulse;
                        const pulse2 = Math.cos(time * 1.5 + v * Math.PI * 8) * config.particlePulse * 0.75;
                        sizes[idx] = (config.particleSize + Math.random() * 0.15) * (1.0 + pulse1 + pulse2 + pulseEffect * 0.5);

                        // å¾‹åŠ¨çš„é€æ˜åº¦
                        const edgeFadeX = Math.sin(u * Math.PI);
                        const edgeFadeY = Math.sin(v * Math.PI);
                        const alphaPulse1 = Math.sin(time * 1.5 + u * Math.PI * 4) * config.particlePulse * 0.75;
                        const alphaPulse2 = Math.cos(time * 2 + v * Math.PI * 6) * config.particlePulse * 0.5;
                        alphas[idx] = edgeFadeX * edgeFadeY * (0.75 + alphaPulse1 + alphaPulse2 + pulseEffect * 0.3);

                        idx++;
                    }
                }

                surface.geometry.attributes.position.needsUpdate = true;
                surface.geometry.attributes.customColor.needsUpdate = true;
                surface.geometry.attributes.size.needsUpdate = true;
                surface.geometry.attributes.alpha.needsUpdate = true;

                surface.points.material.uniforms.time.value = time;
                surface.points.material.uniforms.fresnelIntensity.value = config.fresnelIntensity;
                surface.points.material.uniforms.fresnelPower.value = config.fresnelPower;
                surface.points.material.uniforms.reflectionIntensity.value = config.reflectionIntensity;
                surface.points.material.uniforms.enableFresnel.value = config.enableFresnel ? 1.0 : 0.0;
                surface.points.material.uniforms.enableReflection.value = config.enableReflection ? 1.0 : 0.0;
            });
        }

        // çª—å£å¤§å°è°ƒæ•´
        function onWindowResize() {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
            composer.setSize(window.innerWidth, window.innerHeight);
        }

        // åŠ¨ç”»å¾ªç¯
        function animate() {
            requestAnimationFrame(animate);

            time += 0.01 * config.timeSpeed;

            if (needsRebuild) {
                rebuildScene();
                needsRebuild = false;
            }

            updateRealTimeParameters();
            updateEnergyPulses();
            updateRibbons();

            composer.render();
        }

        // æ›´æ–°å®æ—¶å‚æ•°
        function updateRealTimeParameters() {
            camera.position.z = config.cameraZ;
            camera.fov = config.fov;
            camera.updateProjectionMatrix();

            if (scene.fog) {
                scene.fog.density = config.fogDensity;
            }

            if (bloomPass) {
                bloomPass.strength = config.bloomStrength;
                bloomPass.radius = config.bloomRadius;
                bloomPass.threshold = config.bloomThreshold;
            }

            if (dofPass) {
                dofPass.enabled = config.enableDOF;
                dofPass.uniforms['focusDistance'].value = config.focusDistance;
                dofPass.uniforms['dofRange'].value = config.dofRange;
                dofPass.uniforms['blurStrength'].value = config.blurStrength;
            }

            if (glitchPass) {
                glitchPass.enabled = config.enableGlitch;
                glitchPass.uniforms['time'].value = time;
                glitchPass.uniforms['intensity'].value = config.glitchIntensity;
                glitchPass.uniforms['frequency'].value = config.glitchFrequency;
            }

            renderer.toneMappingExposure = config.brightness;

            ribbons.forEach(surface => {
                if (surface.points && surface.points.material && surface.points.material.uniforms) {
                    surface.points.material.uniforms.colorStart.value = config.colorStart;
                    surface.points.material.uniforms.colorEnd.value = config.colorEnd;
                }
            });
        }

        // é‡å»ºåœºæ™¯
        function rebuildScene() {
            ribbons.forEach(surface => {
                scene.remove(surface.points);
                surface.geometry.dispose();
                surface.points.material.dispose();
            });
            ribbons = [];

            createSurfaces();
        }

        // è®¾ç½®æ§åˆ¶é¢æ¿äº‹ä»¶ç›‘å¬å™¨
        function setupControls() {
            setupSlider('surfaceCount', (val) => {
                config.surfaceCount = parseInt(val);
                needsRebuild = true;
            });

            setupSlider('gridDensity', (val) => {
                config.gridDensity = parseFloat(val);
                needsRebuild = true;
            });

            setupSlider('surfaceWidth', (val) => {
                config.surfaceWidth = parseFloat(val);
            });

            setupSlider('surfaceHeight', (val) => {
                config.surfaceHeight = parseFloat(val);
            });

            setupColorPicker('colorStart', (val) => {
                config.colorStart = new THREE.Color(val);
            });

            setupColorPicker('colorEnd', (val) => {
                config.colorEnd = new THREE.Color(val);
            });

            setupSlider('colorFlowSpeed', (val) => {
                config.colorFlowSpeed = parseFloat(val);
            });

            setupSlider('bloomStrength', (val) => {
                config.bloomStrength = parseFloat(val);
            });

            setupSlider('bloomRadius', (val) => {
                config.bloomRadius = parseFloat(val);
            });

            setupSlider('bloomThreshold', (val) => {
                config.bloomThreshold = parseFloat(val);
            });

            setupSlider('brightness', (val) => {
                config.brightness = parseFloat(val);
            });

            setupSlider('waveAmplitude', (val) => {
                config.waveAmplitude = parseFloat(val);
            });

            setupSlider('waveSpeed', (val) => {
                config.waveSpeed = parseFloat(val);
            });

            setupSlider('spiralFreq', (val) => {
                config.spiralFreq = parseFloat(val);
            });

            setupSlider('spiralAmp', (val) => {
                config.spiralAmp = parseFloat(val);
            });

            setupSlider('twistStrength', (val) => {
                config.twistStrength = parseFloat(val);
            });

            setupSlider('dnaStrength', (val) => {
                config.dnaStrength = parseFloat(val);
            });

            setupSlider('particleSize', (val) => {
                config.particleSize = parseFloat(val);
            });

            setupSlider('particlePulse', (val) => {
                config.particlePulse = parseFloat(val);
            });

            setupSlider('cameraZ', (val) => {
                config.cameraZ = parseFloat(val);
            });

            setupSlider('fov', (val) => {
                config.fov = parseFloat(val);
            });

            setupSlider('fogDensity', (val) => {
                config.fogDensity = parseFloat(val);
            });

            setupSlider('timeSpeed', (val) => {
                config.timeSpeed = parseFloat(val);
            });

            // æ–°å¢ç‰¹æ•ˆæ§åˆ¶
            setupCheckbox('enableMagnetic', (val) => {
                config.enableMagnetic = val;
            });

            setupSlider('magneticStrength', (val) => {
                config.magneticStrength = parseFloat(val);
            });

            setupSlider('magneticRange', (val) => {
                config.magneticRange = parseFloat(val);
            });

            setupCheckbox('enablePulse', (val) => {
                config.enablePulse = val;
            });

            setupSlider('pulseSpeed', (val) => {
                config.pulseSpeed = parseFloat(val);
            });

            setupSlider('pulseIntensity', (val) => {
                config.pulseIntensity = parseFloat(val);
            });

            setupSlider('pulseFrequency', (val) => {
                config.pulseFrequency = parseFloat(val);
            });

            setupCheckbox('enableDOF', (val) => {
                config.enableDOF = val;
            });

            setupSlider('focusDistance', (val) => {
                config.focusDistance = parseFloat(val);
            });

            setupSlider('dofRange', (val) => {
                config.dofRange = parseFloat(val);
            });

            setupSlider('blurStrength', (val) => {
                config.blurStrength = parseFloat(val);
            });

            setupCheckbox('enableGlitch', (val) => {
                config.enableGlitch = val;
            });

            setupSlider('glitchIntensity', (val) => {
                config.glitchIntensity = parseFloat(val);
            });

            setupSlider('glitchFrequency', (val) => {
                config.glitchFrequency = parseFloat(val);
            });

            setupCheckbox('enableFresnel', (val) => {
                config.enableFresnel = val;
            });

            setupSlider('fresnelIntensity', (val) => {
                config.fresnelIntensity = parseFloat(val);
            });

            setupSlider('fresnelPower', (val) => {
                config.fresnelPower = parseFloat(val);
            });

            setupCheckbox('enableReflection', (val) => {
                config.enableReflection = val;
            });

            setupSlider('reflectionIntensity', (val) => {
                config.reflectionIntensity = parseFloat(val);
            });

            setupSlider('refractionIndex', (val) => {
                config.refractionIndex = parseFloat(val);
            });
        }

        // è¾…åŠ©å‡½æ•°ï¼šè®¾ç½®æ»‘å—
        function setupSlider(id, callback) {
            const slider = document.getElementById(id);
            const valueDisplay = document.getElementById(id + '-value');

            slider.addEventListener('input', (e) => {
                const val = e.target.value;
                callback(val);

                const step = parseFloat(slider.step);
                if (step >= 1) {
                    valueDisplay.textContent = parseInt(val);
                } else if (step >= 0.1) {
                    valueDisplay.textContent = parseFloat(val).toFixed(1);
                } else if (step >= 0.01) {
                    valueDisplay.textContent = parseFloat(val).toFixed(2);
                } else if (step >= 0.001) {
                    valueDisplay.textContent = parseFloat(val).toFixed(3);
                } else {
                    valueDisplay.textContent = parseFloat(val).toFixed(4);
                }
            });
        }

        // è¾…åŠ©å‡½æ•°ï¼šè®¾ç½®é¢œè‰²é€‰æ‹©å™¨
        function setupColorPicker(id, callback) {
            const picker = document.getElementById(id);
            picker.addEventListener('input', (e) => {
                callback(e.target.value);
            });
        }

        // è¾…åŠ©å‡½æ•°ï¼šè®¾ç½®å¤é€‰æ¡†
        function setupCheckbox(id, callback) {
            const checkbox = document.getElementById(id);
            checkbox.addEventListener('change', (e) => {
                callback(e.target.checked);
            });
        }

        // å¯åŠ¨
        init();
        animate();
    </script>
</body>
</html>
