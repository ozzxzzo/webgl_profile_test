<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quantum Energy Ribbons - é‡å­èƒ½é‡ä¸å¸¦Â·ç»ˆæäº¤äº’ç‰ˆ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            overflow: hidden;
        }

        body {
            background: #0a0a0f;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            cursor: none;
        }

        canvas {
            display: block;
            width: 100vw;
            height: 100vh;
        }

        #cursor {
            position: fixed;
            width: 40px;
            height: 40px;
            border: 2px solid #28f321;
            border-radius: 50%;
            pointer-events: none;
            z-index: 10000;
            mix-blend-mode: screen;
            transition: transform 0.1s ease;
            box-shadow: 0 0 20px rgba(40, 243, 33, 0.6),
                        inset 0 0 20px rgba(40, 243, 33, 0.3);
        }

        #cursor::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 6px;
            height: 6px;
            background: #28f321;
            border-radius: 50%;
            box-shadow: 0 0 10px #28f321;
        }

        #info {
            position: absolute;
            top: 20px;
            left: 20px;
            color: rgba(255, 255, 255, 0.7);
            font-size: 14px;
            pointer-events: none;
            text-shadow: 0 0 10px rgba(0, 0, 0, 0.5);
            line-height: 1.6;
            z-index: 100;
        }

        #info .title {
            font-size: 20px;
            font-weight: bold;
            color: #28f321;
            text-shadow: 0 0 15px rgba(40, 243, 33, 0.8);
            margin-bottom: 8px;
        }

        #info .features {
            margin-top: 10px;
            font-size: 10px;
            color: rgba(255, 255, 255, 0.5);
        }

        #loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: #28f321;
            font-size: 24px;
            text-shadow: 0 0 20px #28f321;
        }

        #controlPanel {
            position: absolute;
            top: 20px;
            right: 20px;
            width: 360px;
            max-height: 90vh;
            overflow-y: auto;
            background: rgba(10, 10, 15, 0.95);
            border: 1px solid rgba(40, 243, 33, 0.3);
            border-radius: 12px;
            padding: 20px;
            color: #fff;
            font-size: 13px;
            box-shadow: 0 0 40px rgba(40, 243, 33, 0.2), 0 0 80px rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(15px);
            display: none;
            opacity: 0;
            transform: translateX(20px);
            transition: opacity 0.3s ease, transform 0.3s ease;
            z-index: 100;
        }

        #controlPanel.visible {
            opacity: 1;
            transform: translateX(0);
        }

        #controlPanel h2 {
            margin: 0 0 15px 0;
            font-size: 20px;
            color: #28f321;
            text-shadow: 0 0 15px rgba(40, 243, 33, 0.6);
            text-align: center;
        }

        .control-section {
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .control-section:last-child {
            border-bottom: none;
        }

        .control-section h3 {
            margin: 0 0 12px 0;
            font-size: 15px;
            color: #2196F3;
            font-weight: bold;
        }

        .control-group {
            margin-bottom: 12px;
        }

        .control-group label {
            display: block;
            margin-bottom: 6px;
            color: rgba(255, 255, 255, 0.85);
            font-size: 12px;
        }

        .control-group input[type="range"] {
            width: 100%;
            height: 4px;
            border-radius: 2px;
            background: rgba(255, 255, 255, 0.2);
            outline: none;
            -webkit-appearance: none;
        }

        .control-group input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 14px;
            height: 14px;
            border-radius: 50%;
            background: #28f321;
            cursor: pointer;
            box-shadow: 0 0 8px rgba(40, 243, 33, 0.6);
        }

        .control-group input[type="range"]::-moz-range-thumb {
            width: 14px;
            height: 14px;
            border-radius: 50%;
            background: #28f321;
            cursor: pointer;
            border: none;
            box-shadow: 0 0 8px rgba(40, 243, 33, 0.6);
        }

        .control-group input[type="color"] {
            width: 100%;
            height: 32px;
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 4px;
            background: transparent;
            cursor: pointer;
        }

        .control-group input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
            margin-right: 8px;
            vertical-align: middle;
        }

        .control-group .checkbox-label {
            display: inline-block;
            vertical-align: middle;
        }

        .control-group .value-display {
            float: right;
            color: #28f321;
            font-weight: bold;
            font-size: 12px;
        }

        button {
            width: 100%;
            padding: 12px;
            margin-top: 10px;
            background: rgba(40, 243, 33, 0.15);
            border: 1px solid #28f321;
            border-radius: 6px;
            color: #28f321;
            font-size: 13px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
        }

        button:hover {
            background: rgba(40, 243, 33, 0.25);
            box-shadow: 0 0 20px rgba(40, 243, 33, 0.4);
            transform: translateY(-1px);
        }

        button:active {
            transform: translateY(0);
        }

        .toggle-btn {
            position: absolute;
            top: 20px;
            right: 20px;
            padding: 10px 18px;
            width: auto;
            background: rgba(10, 10, 15, 0.9);
            border: 1px solid rgba(40, 243, 33, 0.4);
            margin: 0;
            transition: right 0.3s ease;
            font-size: 12px;
            z-index: 100;
        }

        #controlPanel::-webkit-scrollbar {
            width: 6px;
        }

        #controlPanel::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 3px;
        }

        #controlPanel::-webkit-scrollbar-thumb {
            background: rgba(40, 243, 33, 0.5);
            border-radius: 3px;
        }

        #controlPanel::-webkit-scrollbar-thumb:hover {
            background: rgba(40, 243, 33, 0.7);
        }

        .effect-badge {
            display: inline-block;
            padding: 3px 10px;
            margin: 3px;
            background: rgba(40, 243, 33, 0.2);
            border: 1px solid rgba(40, 243, 33, 0.4);
            border-radius: 12px;
            font-size: 10px;
            color: #28f321;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div id="cursor"></div>
    <div id="loading">Loading Ultimate Interactive Effects...</div>
    <div id="info">
        <div class="title">âš¡ Quantum Energy Ribbons âš¡</div>
        <div>é‡å­èƒ½é‡ä¸å¸¦ Â· ç²¾é€‰ç‰ˆ Â· 6 Effects</div>
        <div class="features">
            <span class="effect-badge">ğŸŒ€ Repulsion</span>
            <span class="effect-badge">ğŸŒŠ Ripple</span>
            <span class="effect-badge">ğŸ¨ Infection</span><br>
            <span class="effect-badge">â±ï¸ TimeDilation</span>
            <span class="effect-badge">ğŸ“· DOF</span>
            <span class="effect-badge">ğŸ’ Reflect</span>
        </div>
    </div>

    <button class="toggle-btn" onclick="togglePanel()">æ§åˆ¶é¢æ¿</button>

    <div id="controlPanel">
        <h2>ğŸ›ï¸ ç»ˆæäº¤äº’æ§åˆ¶é¢æ¿</h2>

        <div class="control-section">
            <h3>ğŸ¨ åŸºç¡€å‚æ•° Basic</h3>
            <div class="control-group">
                <label>æ›²é¢æ•°é‡ Surfaces: <span class="value-display" id="surfaceCount-value">1</span></label>
                <input type="range" id="surfaceCount" min="1" max="10" step="1" value="1">
            </div>
            <div class="control-group">
                <label>ç½‘æ ¼å¯†åº¦ Grid Density: <span class="value-display" id="gridDensity-value">1.7</span></label>
                <input type="range" id="gridDensity" min="0.2" max="2" step="0.1" value="1.7">
            </div>
            <div class="control-group">
                <label>ä¸å¸¦å®½åº¦ Ribbon Width: <span class="value-display" id="surfaceWidth-value">200</span></label>
                <input type="range" id="surfaceWidth" min="30" max="200" step="5" value="200">
            </div>
            <div class="control-group">
                <label>ä¸å¸¦é«˜åº¦ Ribbon Height: <span class="value-display" id="surfaceHeight-value">29</span></label>
                <input type="range" id="surfaceHeight" min="5" max="40" step="1" value="29">
            </div>
        </div>

        <div class="control-section">
            <h3>ğŸŒˆ é¢œè‰² Colors</h3>
            <div class="control-group">
                <label>èµ·å§‹é¢œè‰² Start Color</label>
                <input type="color" id="colorStart" value="#28f321">
            </div>
            <div class="control-group">
                <label>ç»“æŸé¢œè‰² End Color</label>
                <input type="color" id="colorEnd" value="#2196f3">
            </div>
            <div class="control-group">
                <label>é¢œè‰²æµåŠ¨é€Ÿåº¦ Color Flow: <span class="value-display" id="colorFlowSpeed-value">0.05</span></label>
                <input type="range" id="colorFlowSpeed" min="0" max="0.5" step="0.01" value="0.05">
            </div>
        </div>

        <div class="control-section">
            <h3>ğŸ® é¼ æ ‡äº¤äº’ç‰¹æ•ˆ Mouse Effects</h3>
            <p style="font-size: 11px; color: rgba(255,255,255,0.6); margin-bottom: 15px;">ä»¥ä¸‹æ‰€æœ‰ç‰¹æ•ˆåŸºäºé¼ æ ‡ä½ç½®å®æ—¶ç”Ÿæ•ˆ</p>
        </div>

        <div class="control-section">
            <h3>ğŸŒ€ æ¨åŠ›æ’æ–¥åœº Repulsion Field</h3>
            <div class="control-group">
                <label>
                    <input type="checkbox" id="enableRepulsion">
                    <span class="checkbox-label">å¯ç”¨æ’æ–¥åŠ› Enable Repulsion</span>
                </label>
            </div>
            <div class="control-group">
                <label>æ’æ–¥å¼ºåº¦ Strength: <span class="value-display" id="repulsionStrength-value">20.0</span></label>
                <input type="range" id="repulsionStrength" min="0" max="50" step="1" value="20">
            </div>
            <div class="control-group">
                <label>ä½œç”¨èŒƒå›´ Range: <span class="value-display" id="repulsionRange-value">100</span></label>
                <input type="range" id="repulsionRange" min="20" max="200" step="10" value="100">
            </div>
        </div>

        <div class="control-section">
            <h3>ğŸŒŠ æ³¢çº¹æ‰©æ•£ Ripple Wave</h3>
            <div class="control-group">
                <label>
                    <input type="checkbox" id="enableRipple" checked>
                    <span class="checkbox-label">å¯ç”¨æ³¢çº¹ Enable Ripple (ç‚¹å‡»)</span>
                </label>
            </div>
            <div class="control-group">
                <label>æ³¢çº¹å¼ºåº¦ Strength: <span class="value-display" id="rippleStrength-value">25.0</span></label>
                <input type="range" id="rippleStrength" min="5" max="50" step="1" value="25">
            </div>
            <div class="control-group">
                <label>æ³¢çº¹é€Ÿåº¦ Speed: <span class="value-display" id="rippleSpeed-value">0.8</span></label>
                <input type="range" id="rippleSpeed" min="0.2" max="2" step="0.1" value="0.8">
            </div>
            <div class="control-group">
                <label>æ³¢çº¹è¡°å‡ Decay: <span class="value-display" id="rippleDecay-value">0.02</span></label>
                <input type="range" id="rippleDecay" min="0.01" max="0.1" step="0.01" value="0.02">
            </div>
        </div>

        <div class="control-section">
            <h3>ğŸ¨ è‰²å½©æ„ŸæŸ“ Color Infection</h3>
            <div class="control-group">
                <label>
                    <input type="checkbox" id="enableInfection">
                    <span class="checkbox-label">å¯ç”¨è‰²å½©æ„ŸæŸ“ Enable Infection</span>
                </label>
            </div>
            <div class="control-group">
                <label>æ„ŸæŸ“é¢œè‰² Infection Color</label>
                <input type="color" id="infectionColor" value="#ff00ff">
            </div>
            <div class="control-group">
                <label>æ„ŸæŸ“å¼ºåº¦ Intensity: <span class="value-display" id="infectionIntensity-value">0.8</span></label>
                <input type="range" id="infectionIntensity" min="0" max="1" step="0.1" value="0.8">
            </div>
            <div class="control-group">
                <label>æ„ŸæŸ“èŒƒå›´ Range: <span class="value-display" id="infectionRange-value">100</span></label>
                <input type="range" id="infectionRange" min="30" max="200" step="10" value="100">
            </div>
        </div>

        <div class="control-section">
            <h3>â±ï¸ æ—¶é—´è†¨èƒ€ Time Dilation</h3>
            <div class="control-group">
                <label>
                    <input type="checkbox" id="enableTimeDilation">
                    <span class="checkbox-label">å¯ç”¨æ—¶é—´è†¨èƒ€ Enable Time Dilation</span>
                </label>
            </div>
            <div class="control-group">
                <label>è†¨èƒ€ç³»æ•° Factor: <span class="value-display" id="timeDilationFactor-value">0.3</span></label>
                <input type="range" id="timeDilationFactor" min="0.1" max="2" step="0.1" value="0.3">
            </div>
            <div class="control-group">
                <label>ä½œç”¨èŒƒå›´ Range: <span class="value-display" id="timeDilationRange-value">100</span></label>
                <input type="range" id="timeDilationRange" min="0" max="200" step="10" value="100">
            </div>
        </div>

        <div class="control-section">
            <h3>ğŸ“· æ™¯æ·± Depth of Field</h3>
            <div class="control-group">
                <label>
                    <input type="checkbox" id="enableDOF" checked>
                    <span class="checkbox-label">å¯ç”¨æ™¯æ·± Enable DOF</span>
                </label>
            </div>
            <div class="control-group">
                <label>ç„¦è· Focus Distance: <span class="value-display" id="focusDistance-value">50</span></label>
                <input type="range" id="focusDistance" min="20" max="150" step="5" value="50">
            </div>
            <div class="control-group">
                <label>æ™¯æ·±èŒƒå›´ DOF Range: <span class="value-display" id="dofRange-value">30</span></label>
                <input type="range" id="dofRange" min="10" max="100" step="5" value="30">
            </div>
            <div class="control-group">
                <label>è™šåŒ–å¼ºåº¦ Blur Strength: <span class="value-display" id="blurStrength-value">1.5</span></label>
                <input type="range" id="blurStrength" min="0" max="5" step="0.1" value="1.5">
            </div>
        </div>

        <div class="control-section">
            <h3>ğŸ’ åå°„æŠ˜å°„ Reflection</h3>
            <div class="control-group">
                <label>
                    <input type="checkbox" id="enableReflection" checked>
                    <span class="checkbox-label">å¯ç”¨åå°„ Enable Reflection</span>
                </label>
            </div>
            <div class="control-group">
                <label>åå°„å¼ºåº¦ Intensity: <span class="value-display" id="reflectionIntensity-value">0.6</span></label>
                <input type="range" id="reflectionIntensity" min="0" max="2" step="0.1" value="0.6">
            </div>
            <div class="control-group">
                <label>æŠ˜å°„ç‡ Refraction: <span class="value-display" id="refractionIndex-value">1.5</span></label>
                <input type="range" id="refractionIndex" min="1" max="3" step="0.1" value="1.5">
            </div>
        </div>

        <div class="control-section">
            <h3>âœ¨ å…‰æ•ˆ Lighting</h3>
            <div class="control-group">
                <label>è¾‰å…‰å¼ºåº¦ Bloom Strength: <span class="value-display" id="bloomStrength-value">1.7</span></label>
                <input type="range" id="bloomStrength" min="0" max="3" step="0.1" value="1.7">
            </div>
            <div class="control-group">
                <label>è¾‰å…‰åŠå¾„ Bloom Radius: <span class="value-display" id="bloomRadius-value">0.00</span></label>
                <input type="range" id="bloomRadius" min="0" max="1" step="0.05" value="0.00">
            </div>
            <div class="control-group">
                <label>è¾‰å…‰é˜ˆå€¼ Bloom Threshold: <span class="value-display" id="bloomThreshold-value">0.55</span></label>
                <input type="range" id="bloomThreshold" min="0" max="1" step="0.05" value="0.55">
            </div>
            <div class="control-group">
                <label>äº®åº¦ Brightness: <span class="value-display" id="brightness-value">1.5</span></label>
                <input type="range" id="brightness" min="0.5" max="3" step="0.1" value="1.5">
            </div>
        </div>

        <div class="control-section">
            <h3>ğŸŒŠ æ³¢åŠ¨æ•ˆæœ Wave Effects</h3>
            <div class="control-group">
                <label>æ³¢åŠ¨å¹…åº¦ Wave Amplitude: <span class="value-display" id="waveAmplitude-value">1.7</span></label>
                <input type="range" id="waveAmplitude" min="0" max="8" step="0.1" value="1.7">
            </div>
            <div class="control-group">
                <label>æ³¢åŠ¨é€Ÿåº¦ Wave Speed: <span class="value-display" id="waveSpeed-value">0.27</span></label>
                <input type="range" id="waveSpeed" min="0" max="1" step="0.01" value="0.27">
            </div>
            <div class="control-group">
                <label>èºæ—‹é¢‘ç‡ Spiral Frequency: <span class="value-display" id="spiralFreq-value">11.5</span></label>
                <input type="range" id="spiralFreq" min="0" max="12" step="0.5" value="11.5">
            </div>
            <div class="control-group">
                <label>èºæ—‹å¹…åº¦ Spiral Amplitude: <span class="value-display" id="spiralAmp-value">1.3</span></label>
                <input type="range" id="spiralAmp" min="0" max="5" step="0.1" value="1.3">
            </div>
            <div class="control-group">
                <label>æ‰­æ›²å¼ºåº¦ Twist Strength: <span class="value-display" id="twistStrength-value">1.9</span></label>
                <input type="range" id="twistStrength" min="0" max="3" step="0.1" value="1.9">
            </div>
            <div class="control-group">
                <label>DNAæ•ˆæœå¼ºåº¦ DNA Effect: <span class="value-display" id="dnaStrength-value">0.5</span></label>
                <input type="range" id="dnaStrength" min="0" max="2" step="0.1" value="0.5">
            </div>
        </div>

        <div class="control-section">
            <h3>âœ¨ ç²’å­ Particles</h3>
            <div class="control-group">
                <label>ç²’å­å¤§å° Particle Size: <span class="value-display" id="particleSize-value">0.8</span></label>
                <input type="range" id="particleSize" min="0.2" max="2" step="0.1" value="0.8">
            </div>
            <div class="control-group">
                <label>ç²’å­è„‰åŠ¨ Particle Pulse: <span class="value-display" id="particlePulse-value">0.20</span></label>
                <input type="range" id="particlePulse" min="0" max="1" step="0.05" value="0.20">
            </div>
        </div>

        <div class="control-section">
            <h3>ğŸ“· ç›¸æœºä¸ç¯å¢ƒ Camera</h3>
            <div class="control-group">
                <label>ç›¸æœºè·ç¦» Camera Distance: <span class="value-display" id="cameraZ-value">50</span></label>
                <input type="range" id="cameraZ" min="20" max="150" step="5" value="50">
            </div>
            <div class="control-group">
                <label>è§†é‡è§’åº¦ FOV: <span class="value-display" id="fov-value">60</span></label>
                <input type="range" id="fov" min="30" max="120" step="5" value="60">
            </div>
            <div class="control-group">
                <label>é›¾å¯†åº¦ Fog Density: <span class="value-display" id="fogDensity-value">0.011</span></label>
                <input type="range" id="fogDensity" min="0" max="0.02" step="0.001" value="0.011">
            </div>
            <div class="control-group">
                <label>åŠ¨ç”»é€Ÿåº¦ Animation Speed: <span class="value-display" id="timeSpeed-value">0.8</span></label>
                <input type="range" id="timeSpeed" min="0" max="3" step="0.1" value="0.8">
            </div>
        </div>

        <button onclick="resetToDefault()">ğŸ”„ é‡ç½®é»˜è®¤å€¼ Reset</button>
        <button onclick="randomize()">ğŸ² éšæœºåŒ– Randomize</button>
        <button onclick="toggleAllEffects()">âš¡ å…¨æ•ˆæœå¼€å…³ Toggle All</button>
    </div>

    <script type="importmap">
    {
        "imports": {
            "three": "https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.module.js",
            "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.160.0/examples/jsm/"
        }
    }
    </script>

    <script type="module">
        import * as THREE from 'three';
        import { EffectComposer } from 'three/addons/postprocessing/EffectComposer.js';
        import { RenderPass } from 'three/addons/postprocessing/RenderPass.js';
        import { UnrealBloomPass } from 'three/addons/postprocessing/UnrealBloomPass.js';
        import { ShaderPass } from 'three/addons/postprocessing/ShaderPass.js';
        import { OutputPass } from 'three/addons/postprocessing/OutputPass.js';

        // åœºæ™¯è®¾ç½®
        let scene, camera, renderer, composer, bloomPass, dofPass;
        let ribbons = [];
        let time = 0;
        let mouse = { x: 0, y: 0, worldX: 0, worldY: 0, worldZ: 0 };

        // é¼ æ ‡äº¤äº’ç‰¹æ•ˆæ•°æ®
        let ripples = []; // æ³¢çº¹æ•°ç»„

        // é…ç½®å‚æ•°
        const config = {
            // åŸºç¡€å‚æ•°
            surfaceCount: 1,
            gridWidth: 200,
            gridHeight: 60,
            surfaceWidth: 200,
            surfaceHeight: 29,
            gridDensity: 1.7,

            // é¢œè‰²å‚æ•°
            colorStart: new THREE.Color(0x28f321),
            colorEnd: new THREE.Color(0x2196F3),
            colorFlowSpeed: 0.05,

            // å…‰æ•ˆå‚æ•°
            bloomStrength: 1.7,
            bloomRadius: 0.00,
            bloomThreshold: 0.55,
            brightness: 1.5,

            // æ³¢åŠ¨æ•ˆæœå‚æ•°
            waveAmplitude: 1.7,
            waveSpeed: 0.27,
            spiralFreq: 11.5,
            spiralAmp: 1.3,
            twistStrength: 1.9,
            dnaStrength: 0.5,

            // ç²’å­å‚æ•°
            particleSize: 0.8,
            particlePulse: 0.20,

            // ç›¸æœºä¸ç¯å¢ƒ
            cameraZ: 50,
            fov: 60,
            fogDensity: 0.011,
            timeSpeed: 0.8,

            // é¼ æ ‡äº¤äº’ç‰¹æ•ˆå‚æ•°
            enableRepulsion: false,
            repulsionStrength: 20,
            repulsionRange: 100,

            enableRipple: true,
            rippleStrength: 25,
            rippleSpeed: 0.8,
            rippleDecay: 0.02,

            enableInfection: false,
            infectionColor: new THREE.Color(0xff00ff),
            infectionIntensity: 0.8,
            infectionRange: 100,

            enableTimeDilation: false,
            timeDilationFactor: 0.3,
            timeDilationRange: 100,

            // å…¶ä»–ç‰¹æ•ˆå‚æ•°
            enableDOF: true,
            focusDistance: 50,
            dofRange: 30,
            blurStrength: 1.5,

            enableReflection: true,
            reflectionIntensity: 0.6,
            refractionIndex: 1.5
        };

        // é»˜è®¤é…ç½®å¤‡ä»½
        const defaultConfig = JSON.parse(JSON.stringify({
            ...config,
            colorStart: 0x28f321,
            colorEnd: 0x2196F3,
            infectionColor: 0xff00ff
        }));

        // æ™¯æ·±ç€è‰²å™¨
        const DOFShader = {
            uniforms: {
                'tDiffuse': { value: null },
                'tDepth': { value: null },
                'focusDistance': { value: 50.0 },
                'dofRange': { value: 30.0 },
                'blurStrength': { value: 1.5 },
                'cameraNear': { value: 0.1 },
                'cameraFar': { value: 1000.0 }
            },
            vertexShader: `
                varying vec2 vUv;
                void main() {
                    vUv = uv;
                    gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);
                }
            `,
            fragmentShader: `
                uniform sampler2D tDiffuse;
                uniform float focusDistance;
                uniform float dofRange;
                uniform float blurStrength;
                varying vec2 vUv;

                void main() {
                    vec4 color = texture2D(tDiffuse, vUv);

                    // ç®€åŒ–çš„æ™¯æ·±æ¨¡ç³Š
                    float depth = gl_FragCoord.z / gl_FragCoord.w;
                    float blur = abs(depth - focusDistance) / dofRange;
                    blur = clamp(blur * blurStrength, 0.0, 1.0);

                    // ç®€å•çš„æ¨¡ç³Šé‡‡æ ·
                    vec4 blurred = vec4(0.0);
                    float samples = 9.0;
                    float offset = blur * 0.003;

                    for(float x = -1.0; x <= 1.0; x++) {
                        for(float y = -1.0; y <= 1.0; y++) {
                            vec2 sampleUv = vUv + vec2(x, y) * offset;
                            blurred += texture2D(tDiffuse, sampleUv);
                        }
                    }
                    blurred /= samples;

                    gl_FragColor = mix(color, blurred, blur);
                }
            `
        };

        // è‡ªå®šä¹‰é¼ æ ‡å…‰æ ‡
        const cursor = document.getElementById('cursor');
        document.addEventListener('mousemove', (e) => {
            cursor.style.left = e.clientX - 20 + 'px';
            cursor.style.top = e.clientY - 20 + 'px';

            // æ›´æ–°é¼ æ ‡ä¸–ç•Œåæ ‡
            mouse.x = (e.clientX / window.innerWidth) * 2 - 1;
            mouse.y = -(e.clientY / window.innerHeight) * 2 + 1;

            // è½¬æ¢ä¸ºä¸–ç•Œåæ ‡
            const vector = new THREE.Vector3(mouse.x, mouse.y, 0.5);
            vector.unproject(camera);
            const dir = vector.sub(camera.position).normalize();
            const distance = -camera.position.z / dir.z;
            const pos = camera.position.clone().add(dir.multiplyScalar(distance));

            mouse.worldX = pos.x;
            mouse.worldY = pos.y;
            mouse.worldZ = 0;
        });

        document.addEventListener('click', () => {
            cursor.style.transform = 'scale(1.5)';
            setTimeout(() => {
                cursor.style.transform = 'scale(1)';
            }, 150);

            // åˆ›å»ºæ³¢çº¹æ•ˆæœ
            if (config.enableRipple) {
                ripples.push({
                    x: mouse.worldX,
                    y: mouse.worldY,
                    z: mouse.worldZ,
                    radius: 0,
                    strength: config.rippleStrength
                });
            }
        });

        // æ§åˆ¶é¢æ¿åˆ‡æ¢
        window.togglePanel = function() {
            const panel = document.getElementById('controlPanel');
            const toggleBtn = document.querySelector('.toggle-btn');
            const isVisible = panel.classList.contains('visible');

            if (!isVisible) {
                panel.style.display = 'block';
                setTimeout(() => {
                    panel.classList.add('visible');
                }, 10);
                toggleBtn.style.right = '400px';
                toggleBtn.textContent = 'éšè—é¢æ¿';
            } else {
                panel.classList.remove('visible');
                setTimeout(() => {
                    panel.style.display = 'none';
                }, 300);
                toggleBtn.style.right = '20px';
                toggleBtn.textContent = 'æ§åˆ¶é¢æ¿';
            }
        }

        // é‡ç½®ä¸ºé»˜è®¤å€¼
        window.resetToDefault = function() {
            config.colorStart = new THREE.Color(defaultConfig.colorStart);
            config.colorEnd = new THREE.Color(defaultConfig.colorEnd);
            config.infectionColor = new THREE.Color(defaultConfig.infectionColor);
            Object.assign(config, {
                ...defaultConfig,
                colorStart: config.colorStart,
                colorEnd: config.colorEnd,
                infectionColor: config.infectionColor
            });
            updateUIFromConfig();
            needsRebuild = true;
        }

        // éšæœºåŒ–å‚æ•°
        window.randomize = function() {
            config.surfaceCount = Math.floor(Math.random() * 8) + 2;
            config.gridDensity = Math.random() * 1.5 + 0.5;
            config.surfaceWidth = Math.random() * 120 + 50;
            config.surfaceHeight = Math.random() * 30 + 10;
            config.colorFlowSpeed = Math.random() * 0.4;
            config.bloomStrength = Math.random() * 2 + 0.5;
            config.bloomRadius = Math.random();
            config.bloomThreshold = Math.random() * 0.5;
            config.brightness = Math.random() * 2 + 0.5;
            config.waveAmplitude = Math.random() * 6 + 1;
            config.waveSpeed = Math.random() * 0.8 + 0.1;
            config.spiralFreq = Math.random() * 10 + 1;
            config.spiralAmp = Math.random() * 4 + 0.5;
            config.twistStrength = Math.random() * 2;
            config.dnaStrength = Math.random() * 1.5;
            config.particleSize = Math.random() * 1.5 + 0.3;
            config.particlePulse = Math.random() * 0.8;
            config.cameraZ = Math.random() * 80 + 40;
            config.fov = Math.random() * 60 + 40;
            config.fogDensity = Math.random() * 0.015;
            config.timeSpeed = Math.random() * 2 + 0.2;

            const randomColor1 = '#' + Math.floor(Math.random()*16777215).toString(16).padStart(6, '0');
            const randomColor2 = '#' + Math.floor(Math.random()*16777215).toString(16).padStart(6, '0');
            config.colorStart = new THREE.Color(randomColor1);
            config.colorEnd = new THREE.Color(randomColor2);

            config.reflectionIntensity = Math.random() * 1.5;

            updateUIFromConfig();
            needsRebuild = true;
        }

        // å…¨æ•ˆæœå¼€å…³
        window.toggleAllEffects = function() {
            const allEnabled = config.enableRepulsion && config.enableRipple && config.enableInfection &&
                              config.enableTimeDilation && config.enableDOF && config.enableReflection;

            config.enableRepulsion = !allEnabled;
            config.enableRipple = !allEnabled;
            config.enableInfection = !allEnabled;
            config.enableTimeDilation = !allEnabled;
            config.enableDOF = !allEnabled;
            config.enableReflection = !allEnabled;

            updateUIFromConfig();
        }

        // ä»é…ç½®æ›´æ–°UI
        function updateUIFromConfig() {
            document.getElementById('surfaceCount').value = config.surfaceCount;
            document.getElementById('surfaceCount-value').textContent = config.surfaceCount;

            document.getElementById('gridDensity').value = config.gridDensity;
            document.getElementById('gridDensity-value').textContent = config.gridDensity.toFixed(1);

            document.getElementById('surfaceWidth').value = config.surfaceWidth;
            document.getElementById('surfaceWidth-value').textContent = Math.round(config.surfaceWidth);

            document.getElementById('surfaceHeight').value = config.surfaceHeight;
            document.getElementById('surfaceHeight-value').textContent = Math.round(config.surfaceHeight);

            document.getElementById('colorStart').value = '#' + config.colorStart.getHexString();
            document.getElementById('colorEnd').value = '#' + config.colorEnd.getHexString();

            document.getElementById('colorFlowSpeed').value = config.colorFlowSpeed;
            document.getElementById('colorFlowSpeed-value').textContent = config.colorFlowSpeed.toFixed(2);

            document.getElementById('bloomStrength').value = config.bloomStrength;
            document.getElementById('bloomStrength-value').textContent = config.bloomStrength.toFixed(1);

            document.getElementById('bloomRadius').value = config.bloomRadius;
            document.getElementById('bloomRadius-value').textContent = config.bloomRadius.toFixed(2);

            document.getElementById('bloomThreshold').value = config.bloomThreshold;
            document.getElementById('bloomThreshold-value').textContent = config.bloomThreshold.toFixed(2);

            document.getElementById('brightness').value = config.brightness;
            document.getElementById('brightness-value').textContent = config.brightness.toFixed(1);

            document.getElementById('waveAmplitude').value = config.waveAmplitude;
            document.getElementById('waveAmplitude-value').textContent = config.waveAmplitude.toFixed(1);

            document.getElementById('waveSpeed').value = config.waveSpeed;
            document.getElementById('waveSpeed-value').textContent = config.waveSpeed.toFixed(2);

            document.getElementById('spiralFreq').value = config.spiralFreq;
            document.getElementById('spiralFreq-value').textContent = config.spiralFreq.toFixed(1);

            document.getElementById('spiralAmp').value = config.spiralAmp;
            document.getElementById('spiralAmp-value').textContent = config.spiralAmp.toFixed(1);

            document.getElementById('twistStrength').value = config.twistStrength;
            document.getElementById('twistStrength-value').textContent = config.twistStrength.toFixed(1);

            document.getElementById('dnaStrength').value = config.dnaStrength;
            document.getElementById('dnaStrength-value').textContent = config.dnaStrength.toFixed(1);

            document.getElementById('particleSize').value = config.particleSize;
            document.getElementById('particleSize-value').textContent = config.particleSize.toFixed(1);

            document.getElementById('particlePulse').value = config.particlePulse;
            document.getElementById('particlePulse-value').textContent = config.particlePulse.toFixed(2);

            document.getElementById('cameraZ').value = config.cameraZ;
            document.getElementById('cameraZ-value').textContent = Math.round(config.cameraZ);

            document.getElementById('fov').value = config.fov;
            document.getElementById('fov-value').textContent = Math.round(config.fov);

            document.getElementById('fogDensity').value = config.fogDensity;
            document.getElementById('fogDensity-value').textContent = config.fogDensity.toFixed(3);

            document.getElementById('timeSpeed').value = config.timeSpeed;
            document.getElementById('timeSpeed-value').textContent = config.timeSpeed.toFixed(1);

            // é¼ æ ‡äº¤äº’ç‰¹æ•ˆ
            document.getElementById('enableRepulsion').checked = config.enableRepulsion;
            document.getElementById('repulsionStrength').value = config.repulsionStrength;
            document.getElementById('repulsionStrength-value').textContent = config.repulsionStrength.toFixed(1);
            document.getElementById('repulsionRange').value = config.repulsionRange;
            document.getElementById('repulsionRange-value').textContent = Math.round(config.repulsionRange);

            document.getElementById('enableRipple').checked = config.enableRipple;
            document.getElementById('rippleStrength').value = config.rippleStrength;
            document.getElementById('rippleStrength-value').textContent = config.rippleStrength.toFixed(1);
            document.getElementById('rippleSpeed').value = config.rippleSpeed;
            document.getElementById('rippleSpeed-value').textContent = config.rippleSpeed.toFixed(1);
            document.getElementById('rippleDecay').value = config.rippleDecay;
            document.getElementById('rippleDecay-value').textContent = config.rippleDecay.toFixed(2);

            document.getElementById('enableInfection').checked = config.enableInfection;
            document.getElementById('infectionColor').value = '#' + config.infectionColor.getHexString();
            document.getElementById('infectionIntensity').value = config.infectionIntensity;
            document.getElementById('infectionIntensity-value').textContent = config.infectionIntensity.toFixed(1);
            document.getElementById('infectionRange').value = config.infectionRange;
            document.getElementById('infectionRange-value').textContent = Math.round(config.infectionRange);

            document.getElementById('enableTimeDilation').checked = config.enableTimeDilation;
            document.getElementById('timeDilationFactor').value = config.timeDilationFactor;
            document.getElementById('timeDilationFactor-value').textContent = config.timeDilationFactor.toFixed(1);
            document.getElementById('timeDilationRange').value = config.timeDilationRange;
            document.getElementById('timeDilationRange-value').textContent = Math.round(config.timeDilationRange);

            document.getElementById('enableDOF').checked = config.enableDOF;
            document.getElementById('focusDistance').value = config.focusDistance;
            document.getElementById('focusDistance-value').textContent = Math.round(config.focusDistance);
            document.getElementById('dofRange').value = config.dofRange;
            document.getElementById('dofRange-value').textContent = Math.round(config.dofRange);
            document.getElementById('blurStrength').value = config.blurStrength;
            document.getElementById('blurStrength-value').textContent = config.blurStrength.toFixed(1);

            document.getElementById('enableReflection').checked = config.enableReflection;
            document.getElementById('reflectionIntensity').value = config.reflectionIntensity;
            document.getElementById('reflectionIntensity-value').textContent = config.reflectionIntensity.toFixed(1);
            document.getElementById('refractionIndex').value = config.refractionIndex;
            document.getElementById('refractionIndex-value').textContent = config.refractionIndex.toFixed(1);
        }

        // éœ€è¦é‡å»ºæ ‡å¿—
        let needsRebuild = false;

        // åˆå§‹åŒ–åœºæ™¯
        function init() {
            scene = new THREE.Scene();
            scene.fog = new THREE.FogExp2(0x0a0a0f, config.fogDensity);

            camera = new THREE.PerspectiveCamera(
                config.fov,
                window.innerWidth / window.innerHeight,
                0.1,
                1000
            );
            camera.position.set(0, 0, config.cameraZ);
            camera.lookAt(0, 0, 0);

            renderer = new THREE.WebGLRenderer({
                antialias: true,
                alpha: true
            });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
            renderer.toneMapping = THREE.ACESFilmicToneMapping;
            renderer.toneMappingExposure = config.brightness;
            document.body.appendChild(renderer.domElement);

            setupPostProcessing();
            createSurfaces();
            setupControls();
            updateUIFromConfig();

            window.addEventListener('resize', onWindowResize);
            document.getElementById('loading').style.display = 'none';
        }

        // è®¾ç½®åå¤„ç†
        function setupPostProcessing() {
            composer = new EffectComposer(renderer);

            const renderPass = new RenderPass(scene, camera);
            composer.addPass(renderPass);

            bloomPass = new UnrealBloomPass(
                new THREE.Vector2(window.innerWidth, window.innerHeight),
                config.bloomStrength,
                config.bloomRadius,
                config.bloomThreshold
            );
            composer.addPass(bloomPass);

            dofPass = new ShaderPass(DOFShader);
            dofPass.uniforms['focusDistance'].value = config.focusDistance;
            dofPass.uniforms['dofRange'].value = config.dofRange;
            dofPass.uniforms['blurStrength'].value = config.blurStrength;
            composer.addPass(dofPass);

            const outputPass = new OutputPass();
            composer.addPass(outputPass);
        }

        // åˆ›å»ºç²’å­æè´¨ï¼ˆå¸¦åå°„ï¼‰
        function createParticleMaterial() {
            return new THREE.ShaderMaterial({
                uniforms: {
                    time: { value: 0 },
                    colorStart: { value: config.colorStart },
                    colorEnd: { value: config.colorEnd },
                    reflectionIntensity: { value: config.reflectionIntensity },
                    enableReflection: { value: config.enableReflection ? 1.0 : 0.0 }
                },
                vertexShader: `
                    attribute float alpha;
                    attribute float size;
                    attribute vec3 customColor;

                    varying vec3 vColor;
                    varying float vAlpha;
                    varying vec3 vPosition;
                    varying vec3 vNormal;
                    varying vec3 vViewPosition;

                    void main() {
                        vColor = customColor;
                        vAlpha = alpha;
                        vPosition = position;
                        vNormal = normalize(position);

                        vec4 mvPosition = modelViewMatrix * vec4(position, 1.0);
                        vViewPosition = -mvPosition.xyz;

                        gl_PointSize = size * (300.0 / -mvPosition.z);
                        gl_Position = projectionMatrix * mvPosition;
                    }
                `,
                fragmentShader: `
                    uniform float time;
                    uniform vec3 colorStart;
                    uniform vec3 colorEnd;
                    uniform float reflectionIntensity;
                    uniform float enableReflection;

                    varying vec3 vColor;
                    varying float vAlpha;
                    varying vec3 vPosition;
                    varying vec3 vNormal;
                    varying vec3 vViewPosition;

                    void main() {
                        vec2 center = gl_PointCoord - vec2(0.5);
                        vec2 absCenter = abs(center);

                        float cornerRadius = 0.15;
                        float squareSize = 0.45;

                        vec2 d = absCenter - vec2(squareSize - cornerRadius);
                        float dist = length(max(d, 0.0)) + min(max(d.x, d.y), 0.0) - cornerRadius;

                        if (dist > 0.0) discard;

                        float strength = 1.0 - smoothstep(-0.1, 0.0, dist);
                        strength = pow(strength, 1.5);

                        vec3 finalColor = vColor * 1.8;

                        // åå°„æ•ˆæœ
                        if (enableReflection > 0.5) {
                            vec3 normal = normalize(vNormal);
                            vec3 viewDir = normalize(vViewPosition);
                            vec3 reflection = reflect(-viewDir, normal);
                            float reflectionFactor = (sin(reflection.x * 10.0 + time) * 0.5 + 0.5) *
                                                    (cos(reflection.y * 10.0 + time * 0.7) * 0.5 + 0.5);
                            finalColor += vec3(reflectionFactor * reflectionIntensity) * 0.5;
                        }

                        gl_FragColor = vec4(finalColor, strength * vAlpha);
                    }
                `,
                transparent: true,
                blending: THREE.AdditiveBlending,
                depthWrite: false
            });
        }

        // åˆ›å»ºå…‰æµæ›²é¢
        function createSurfaces() {
            for (let i = 0; i < config.surfaceCount; i++) {
                const surface = createSurface(i, config.surfaceCount);
                ribbons.push(surface);
                scene.add(surface.points);
            }
        }

        // åˆ›å»ºå•ä¸ªå…‰æµæ›²é¢
        function createSurface(index, total) {
            const gridW = Math.floor(config.gridWidth * config.gridDensity);
            const gridH = Math.floor(config.gridHeight * config.gridDensity);
            const particleCount = gridW * gridH;
            const geometry = new THREE.BufferGeometry();

            const positions = new Float32Array(particleCount * 3);
            const colors = new Float32Array(particleCount * 3);
            const alphas = new Float32Array(particleCount);
            const sizes = new Float32Array(particleCount);
            const offsets = new Float32Array(particleCount);
            const gridCoords = new Float32Array(particleCount * 2);

            const yOffset = (index - total / 2) * 8;
            const zOffset = (index % 2 === 0 ? 1 : -1) * (3 + index * 2);

            let idx = 0;
            for (let iy = 0; iy < gridH; iy++) {
                for (let ix = 0; ix < gridW; ix++) {
                    const u = ix / (gridW - 1);
                    const v = iy / (gridH - 1);

                    gridCoords[idx * 2] = u;
                    gridCoords[idx * 2 + 1] = v;

                    const x = (u - 0.5) * config.surfaceWidth;
                    const y = (v - 0.5) * config.surfaceHeight + yOffset;
                    const z = zOffset;

                    positions[idx * 3] = x;
                    positions[idx * 3 + 1] = y;
                    positions[idx * 3 + 2] = z;

                    const color = new THREE.Color();
                    color.lerpColors(config.colorStart, config.colorEnd, u);
                    colors[idx * 3] = color.r;
                    colors[idx * 3 + 1] = color.g;
                    colors[idx * 3 + 2] = color.b;

                    const edgeFadeX = Math.sin(u * Math.PI);
                    const edgeFadeY = Math.sin(v * Math.PI);
                    alphas[idx] = edgeFadeX * edgeFadeY * 0.8 + 0.2;

                    sizes[idx] = config.particleSize + Math.random() * 0.3;
                    offsets[idx] = Math.random() * Math.PI * 2;

                    idx++;
                }
            }

            geometry.setAttribute('position', new THREE.BufferAttribute(positions, 3));
            geometry.setAttribute('customColor', new THREE.BufferAttribute(colors, 3));
            geometry.setAttribute('alpha', new THREE.BufferAttribute(alphas, 1));
            geometry.setAttribute('size', new THREE.BufferAttribute(sizes, 1));

            const material = createParticleMaterial();
            const points = new THREE.Points(geometry, material);

            return {
                points,
                geometry,
                offsets,
                gridCoords,
                gridW,
                gridH,
                yOffset,
                zOffset,
                phaseOffset: index * 1.2
            };
        }

        // æ›´æ–°å…‰æµæ›²é¢åŠ¨ç”»
        function updateRibbons() {
            ribbons.forEach((surface, surfaceIndex) => {
                const positions = surface.geometry.attributes.position.array;
                const colors = surface.geometry.attributes.customColor.array;
                const sizes = surface.geometry.attributes.size.array;
                const alphas = surface.geometry.attributes.alpha.array;

                let idx = 0;
                for (let iy = 0; iy < surface.gridH; iy++) {
                    for (let ix = 0; ix < surface.gridW; ix++) {
                        const u = surface.gridCoords[idx * 2];
                        const v = surface.gridCoords[idx * 2 + 1];

                        const x = (u - 0.5) * config.surfaceWidth;
                        const y = (v - 0.5) * config.surfaceHeight + surface.yOffset;
                        const z = surface.zOffset;

                        // å…ˆè®¡ç®—åŸºç¡€ä½ç½®ä»¥ç¡®å®šåˆ°é¼ æ ‡çš„è·ç¦»
                        const baseX = x;
                        const baseY = y;
                        const baseZ = z;
                        const baseDx = mouse.worldX - baseX;
                        const baseDy = mouse.worldY - baseY;
                        const baseDz = mouse.worldZ - baseZ;
                        const mouseDistance = Math.sqrt(baseDx * baseDx + baseDy * baseDy + baseDz * baseDz);

                        // æ—¶é—´è†¨èƒ€ç³»æ•°ï¼ˆé»˜è®¤ä¸º1ï¼‰
                        let timeScale = 1.0;

                        // æ—¶é—´è†¨èƒ€æ•ˆæœ - é¼ æ ‡é™„è¿‘çš„ç²’å­æ—¶é—´å˜æ…¢ï¼ˆä½¿ç”¨å¹³æ»‘è¿‡æ¸¡ï¼‰
                        if (config.enableTimeDilation && mouseDistance < config.timeDilationRange * 1.5) {
                            // æ‰©å¤§å½±å“èŒƒå›´1.5å€ï¼Œåˆ›å»ºæŸ”åŒ–åŒºåŸŸ
                            const extendedRange = config.timeDilationRange * 1.5;
                            const normalizedDist = Math.min(mouseDistance / extendedRange, 1.0);

                            // ä½¿ç”¨ smoothstep å‡½æ•°åˆ›å»ºå¹³æ»‘çš„ S æ›²çº¿è¿‡æ¸¡
                            const smoothFactor = normalizedDist * normalizedDist * (3 - 2 * normalizedDist);
                            const factor = 1 - smoothFactor;

                            const rawTimeScale = 1.0 - factor * (1.0 - config.timeDilationFactor);

                            // æ”¾å¤§æ—¶é—´å·®å¼‚ï¼ˆé™ä½åˆ°3å€ä»¥å‡å°‘è¾¹ç•Œæ•ˆåº”ï¼‰
                            const timeDilationAmplification = 3.0;
                            const timeDiffFactor = 1 - rawTimeScale;
                            const amplifiedDiffFactor = Math.min(timeDiffFactor * timeDilationAmplification, 0.9);
                            timeScale = 1 - amplifiedDiffFactor;
                        }

                        const waveOffset = surface.phaseOffset + time * config.waveSpeed * timeScale;

                        // åŸæœ‰æ³¢åŠ¨æ•ˆæœï¼ˆå—æ—¶é—´è†¨èƒ€å½±å“ï¼‰
                        const spiralY = Math.sin(u * Math.PI * config.spiralFreq + waveOffset + v * Math.PI * 2) * config.spiralAmp;
                        const spiralZ = Math.cos(u * Math.PI * config.spiralFreq + waveOffset + v * Math.PI * 2) * config.spiralAmp;

                        const wave1 = Math.sin(u * Math.PI * 3 + waveOffset) * config.waveAmplitude * 0.8;
                        const wave2 = Math.cos(v * Math.PI * 4 + waveOffset * 1.5) * config.waveAmplitude * 0.5;

                        const centerX = u - 0.5;
                        const centerY = v - 0.5;
                        const distFromCenter = Math.sqrt(centerX * centerX + centerY * centerY);
                        const radialWave = Math.sin(distFromCenter * Math.PI * 6 + waveOffset * 2) * config.waveAmplitude * 0.3;

                        const twistX = Math.sin(u * Math.PI * 12 + time * timeScale * 2) * Math.cos(v * Math.PI * 6 + time * timeScale) * config.twistStrength;
                        const twistY = Math.cos(u * Math.PI * 6 + time * timeScale * 1.5) * Math.sin(v * Math.PI * 12 + time * timeScale * 2) * config.twistStrength;

                        const dnaPhase = u * Math.PI * 8 + waveOffset * 3;
                        const dnaY = Math.sin(dnaPhase + v * Math.PI) * config.dnaStrength;
                        const dnaZ = Math.cos(dnaPhase + v * Math.PI) * config.dnaStrength;

                        let finalX = x + twistX;
                        let finalY = y + spiralY + wave1 + wave2 + radialWave + dnaY + twistY;
                        let finalZ = z + spiralZ + dnaZ;

                        // é‡æ–°è®¡ç®—åˆ°é¼ æ ‡çš„è·ç¦»ï¼ˆç”¨äºå…¶ä»–ç‰¹æ•ˆï¼‰
                        const dx = mouse.worldX - finalX;
                        const dy = mouse.worldY - finalY;
                        const dz = mouse.worldZ - finalZ;
                        const finalMouseDistance = Math.sqrt(dx * dx + dy * dy + dz * dz);

                        // æ’æ–¥åŠ›æ•ˆæœ
                        if (config.enableRepulsion && finalMouseDistance < config.repulsionRange) {
                            const force = (1 - finalMouseDistance / config.repulsionRange) * config.repulsionStrength;
                            finalX -= (dx / finalMouseDistance) * force * 0.1;
                            finalY -= (dy / finalMouseDistance) * force * 0.1;
                            finalZ -= (dz / finalMouseDistance) * force * 0.1;
                        }

                        // æ³¢çº¹æ‰©æ•£æ•ˆæœ
                        for (let r = 0; r < ripples.length; r++) {
                            const ripple = ripples[r];
                            const rdx = finalX - ripple.x;
                            const rdy = finalY - ripple.y;
                            const rdz = finalZ - ripple.z;
                            const rippleDist = Math.sqrt(rdx * rdx + rdy * rdy + rdz * rdz);
                            const rippleEdge = Math.abs(rippleDist - ripple.radius);

                            if (rippleEdge < 10) {
                                const rippleForce = ripple.strength * (1 - rippleEdge / 10) * Math.sin(rippleEdge * 0.5);
                                finalX += (rdx / rippleDist) * rippleForce * 0.05;
                                finalY += (rdy / rippleDist) * rippleForce * 0.05;
                                finalZ += (rdz / rippleDist) * rippleForce * 0.05;
                            }
                        }

                        positions[idx * 3] = finalX;
                        positions[idx * 3 + 1] = finalY;
                        positions[idx * 3 + 2] = finalZ;

                        // åŠ¨æ€å¾ªç¯æ¸å˜è‰²
                        const flowOffset = (time * config.colorFlowSpeed) % 1.0;
                        const colorPos = (u + flowOffset) % 1.0;

                        let t;
                        if (colorPos < 0.5) {
                            t = colorPos * 2;
                        } else {
                            t = (1.0 - colorPos) * 2;
                        }

                        t = t * t * (3 - 2 * t);

                        const color = new THREE.Color();
                        color.lerpColors(config.colorStart, config.colorEnd, t);

                        // è‰²å½©æ„ŸæŸ“æ•ˆæœ
                        if (config.enableInfection && mouseDistance < config.infectionRange) {
                            const infectionFactor = (1 - mouseDistance / config.infectionRange) * config.infectionIntensity;
                            color.lerp(config.infectionColor, infectionFactor);
                        }

                        colors[idx * 3] = color.r;
                        colors[idx * 3 + 1] = color.g;
                        colors[idx * 3 + 2] = color.b;

                        // å¾‹åŠ¨çš„ç²’å­å¤§å°
                        const pulse1 = Math.sin(time * 2 + u * Math.PI * 6) * config.particlePulse;
                        const pulse2 = Math.cos(time * 1.5 + v * Math.PI * 8) * config.particlePulse * 0.75;
                        sizes[idx] = (config.particleSize + Math.random() * 0.15) * (1.0 + pulse1 + pulse2);

                        // å¾‹åŠ¨çš„é€æ˜åº¦
                        const edgeFadeX = Math.sin(u * Math.PI);
                        const edgeFadeY = Math.sin(v * Math.PI);
                        const alphaPulse1 = Math.sin(time * 1.5 + u * Math.PI * 4) * config.particlePulse * 0.75;
                        const alphaPulse2 = Math.cos(time * 2 + v * Math.PI * 6) * config.particlePulse * 0.5;
                        alphas[idx] = edgeFadeX * edgeFadeY * (0.75 + alphaPulse1 + alphaPulse2);

                        idx++;
                    }
                }

                surface.geometry.attributes.position.needsUpdate = true;
                surface.geometry.attributes.customColor.needsUpdate = true;
                surface.geometry.attributes.size.needsUpdate = true;
                surface.geometry.attributes.alpha.needsUpdate = true;

                surface.points.material.uniforms.time.value = time;
                surface.points.material.uniforms.reflectionIntensity.value = config.reflectionIntensity;
                surface.points.material.uniforms.enableReflection.value = config.enableReflection ? 1.0 : 0.0;
            });
        }

        // æ›´æ–°é¼ æ ‡äº¤äº’ç‰¹æ•ˆ
        function updateMouseEffects() {
            // æ›´æ–°æ³¢çº¹
            for (let i = ripples.length - 1; i >= 0; i--) {
                ripples[i].radius += config.rippleSpeed;
                ripples[i].strength *= (1 - config.rippleDecay);
                if (ripples[i].strength < 0.1) {
                    ripples.splice(i, 1);
                }
            }
        }

        // çª—å£å¤§å°è°ƒæ•´
        function onWindowResize() {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
            composer.setSize(window.innerWidth, window.innerHeight);
        }

        // åŠ¨ç”»å¾ªç¯
        function animate() {
            requestAnimationFrame(animate);

            time += 0.01 * config.timeSpeed;

            if (needsRebuild) {
                rebuildScene();
                needsRebuild = false;
            }

            updateRealTimeParameters();
            updateRibbons();
            updateMouseEffects();

            composer.render();
        }

        // æ›´æ–°å®æ—¶å‚æ•°
        function updateRealTimeParameters() {
            camera.position.z = config.cameraZ;
            camera.fov = config.fov;
            camera.updateProjectionMatrix();

            if (scene.fog) {
                scene.fog.density = config.fogDensity;
            }

            if (bloomPass) {
                bloomPass.strength = config.bloomStrength;
                bloomPass.radius = config.bloomRadius;
                bloomPass.threshold = config.bloomThreshold;
            }

            if (dofPass) {
                dofPass.enabled = config.enableDOF;
                dofPass.uniforms['focusDistance'].value = config.focusDistance;
                dofPass.uniforms['dofRange'].value = config.dofRange;
                dofPass.uniforms['blurStrength'].value = config.blurStrength;
            }

            renderer.toneMappingExposure = config.brightness;

            ribbons.forEach(surface => {
                if (surface.points && surface.points.material && surface.points.material.uniforms) {
                    surface.points.material.uniforms.colorStart.value = config.colorStart;
                    surface.points.material.uniforms.colorEnd.value = config.colorEnd;
                }
            });
        }

        // é‡å»ºåœºæ™¯
        function rebuildScene() {
            ribbons.forEach(surface => {
                scene.remove(surface.points);
                surface.geometry.dispose();
                surface.points.material.dispose();
            });
            ribbons = [];

            createSurfaces();
        }

        // è®¾ç½®æ§åˆ¶é¢æ¿äº‹ä»¶ç›‘å¬å™¨
        function setupControls() {
            setupSlider('surfaceCount', (val) => {
                config.surfaceCount = parseInt(val);
                needsRebuild = true;
            });

            setupSlider('gridDensity', (val) => {
                config.gridDensity = parseFloat(val);
                needsRebuild = true;
            });

            setupSlider('surfaceWidth', (val) => {
                config.surfaceWidth = parseFloat(val);
            });

            setupSlider('surfaceHeight', (val) => {
                config.surfaceHeight = parseFloat(val);
            });

            setupColorPicker('colorStart', (val) => {
                config.colorStart = new THREE.Color(val);
            });

            setupColorPicker('colorEnd', (val) => {
                config.colorEnd = new THREE.Color(val);
            });

            setupSlider('colorFlowSpeed', (val) => {
                config.colorFlowSpeed = parseFloat(val);
            });

            setupSlider('bloomStrength', (val) => {
                config.bloomStrength = parseFloat(val);
            });

            setupSlider('bloomRadius', (val) => {
                config.bloomRadius = parseFloat(val);
            });

            setupSlider('bloomThreshold', (val) => {
                config.bloomThreshold = parseFloat(val);
            });

            setupSlider('brightness', (val) => {
                config.brightness = parseFloat(val);
            });

            setupSlider('waveAmplitude', (val) => {
                config.waveAmplitude = parseFloat(val);
            });

            setupSlider('waveSpeed', (val) => {
                config.waveSpeed = parseFloat(val);
            });

            setupSlider('spiralFreq', (val) => {
                config.spiralFreq = parseFloat(val);
            });

            setupSlider('spiralAmp', (val) => {
                config.spiralAmp = parseFloat(val);
            });

            setupSlider('twistStrength', (val) => {
                config.twistStrength = parseFloat(val);
            });

            setupSlider('dnaStrength', (val) => {
                config.dnaStrength = parseFloat(val);
            });

            setupSlider('particleSize', (val) => {
                config.particleSize = parseFloat(val);
            });

            setupSlider('particlePulse', (val) => {
                config.particlePulse = parseFloat(val);
            });

            setupSlider('cameraZ', (val) => {
                config.cameraZ = parseFloat(val);
            });

            setupSlider('fov', (val) => {
                config.fov = parseFloat(val);
            });

            setupSlider('fogDensity', (val) => {
                config.fogDensity = parseFloat(val);
            });

            setupSlider('timeSpeed', (val) => {
                config.timeSpeed = parseFloat(val);
            });

            // é¼ æ ‡äº¤äº’ç‰¹æ•ˆæ§åˆ¶
            setupCheckbox('enableRepulsion', (val) => {
                config.enableRepulsion = val;
            });

            setupSlider('repulsionStrength', (val) => {
                config.repulsionStrength = parseFloat(val);
            });

            setupSlider('repulsionRange', (val) => {
                config.repulsionRange = parseFloat(val);
            });

            setupCheckbox('enableRipple', (val) => {
                config.enableRipple = val;
            });

            setupSlider('rippleStrength', (val) => {
                config.rippleStrength = parseFloat(val);
            });

            setupSlider('rippleSpeed', (val) => {
                config.rippleSpeed = parseFloat(val);
            });

            setupSlider('rippleDecay', (val) => {
                config.rippleDecay = parseFloat(val);
            });

            setupCheckbox('enableInfection', (val) => {
                config.enableInfection = val;
            });

            setupColorPicker('infectionColor', (val) => {
                config.infectionColor = new THREE.Color(val);
            });

            setupSlider('infectionIntensity', (val) => {
                config.infectionIntensity = parseFloat(val);
            });

            setupSlider('infectionRange', (val) => {
                config.infectionRange = parseFloat(val);
            });

            setupCheckbox('enableTimeDilation', (val) => {
                config.enableTimeDilation = val;
            });

            setupSlider('timeDilationFactor', (val) => {
                config.timeDilationFactor = parseFloat(val);
            });

            setupSlider('timeDilationRange', (val) => {
                config.timeDilationRange = parseFloat(val);
            });

            setupCheckbox('enableDOF', (val) => {
                config.enableDOF = val;
            });

            setupSlider('focusDistance', (val) => {
                config.focusDistance = parseFloat(val);
            });

            setupSlider('dofRange', (val) => {
                config.dofRange = parseFloat(val);
            });

            setupSlider('blurStrength', (val) => {
                config.blurStrength = parseFloat(val);
            });

            setupCheckbox('enableReflection', (val) => {
                config.enableReflection = val;
            });

            setupSlider('reflectionIntensity', (val) => {
                config.reflectionIntensity = parseFloat(val);
            });

            setupSlider('refractionIndex', (val) => {
                config.refractionIndex = parseFloat(val);
            });
        }

        // è¾…åŠ©å‡½æ•°ï¼šè®¾ç½®æ»‘å—
        function setupSlider(id, callback) {
            const slider = document.getElementById(id);
            const valueDisplay = document.getElementById(id + '-value');

            slider.addEventListener('input', (e) => {
                const val = e.target.value;
                callback(val);

                const step = parseFloat(slider.step);
                if (step >= 1) {
                    valueDisplay.textContent = parseInt(val);
                } else if (step >= 0.1) {
                    valueDisplay.textContent = parseFloat(val).toFixed(1);
                } else if (step >= 0.01) {
                    valueDisplay.textContent = parseFloat(val).toFixed(2);
                } else if (step >= 0.001) {
                    valueDisplay.textContent = parseFloat(val).toFixed(3);
                } else {
                    valueDisplay.textContent = parseFloat(val).toFixed(4);
                }
            });
        }

        // è¾…åŠ©å‡½æ•°ï¼šè®¾ç½®é¢œè‰²é€‰æ‹©å™¨
        function setupColorPicker(id, callback) {
            const picker = document.getElementById(id);
            picker.addEventListener('input', (e) => {
                callback(e.target.value);
            });
        }

        // è¾…åŠ©å‡½æ•°ï¼šè®¾ç½®å¤é€‰æ¡†
        function setupCheckbox(id, callback) {
            const checkbox = document.getElementById(id);
            checkbox.addEventListener('change', (e) => {
                callback(e.target.checked);
            });
        }

        // å¯åŠ¨
        init();
        animate();
    </script>
</body>
</html>
